{% extends 'admin/master.html' %}

{% block body %}
<h1>INPIT SQLite データベースクエリ例</h1>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-body">
                <div class="alert alert-info">
                    <strong>注意 (Note):</strong> このページのクエリ例はすべてINPIT SQLiteデータベース (inpit.db) 用です。
                    <br>All query examples on this page are specific to the INPIT SQLite database (inpit.db).
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">テーブル情報の取得 (Table Information)</h3>
            </div>
            <div class="box-body">
                <div class="panel-group" id="accordion-table-info">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-table-info" href="#collapse-table-list">
                                    データベース内のテーブル一覧 (List all tables)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-table-list" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT name FROM sqlite_master WHERE type='table';</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT name FROM sqlite_master WHERE type='table';">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT name FROM sqlite_master WHERE type='table';">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-table-info" href="#collapse-table-schema">
                                    テーブルのスキーマ情報 (Table schema information)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-table-schema" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>PRAGMA table_info(inpit_data);</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="PRAGMA table_info(inpit_data);">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="PRAGMA table_info(inpit_data);">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">基本的なSELECT文 (Basic SELECT statements)</h3>
            </div>
            <div class="box-body">
                <div class="panel-group" id="accordion-basic-select">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-basic-select" href="#collapse-select-all">
                                    すべてのデータを取得 (Select all data)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-select-all" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT * FROM inpit_data LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT * FROM inpit_data LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT * FROM inpit_data LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-basic-select" href="#collapse-select-columns">
                                    特定のカラムを選択 (Select specific columns)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-select-columns" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT id, application_number, title FROM inpit_data LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT id, application_number, title FROM inpit_data LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT id, application_number, title FROM inpit_data LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-basic-select" href="#collapse-select-where">
                                    WHERE句による条件抽出 (Filter with WHERE clause)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-select-where" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT * FROM inpit_data WHERE application_date > '2020-01-01' LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT * FROM inpit_data WHERE application_date > '2020-01-01' LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT * FROM inpit_data WHERE application_date > '2020-01-01' LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-basic-select" href="#collapse-select-orderby">
                                    ORDER BY句によるソート (Sort with ORDER BY)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-select-orderby" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT * FROM inpit_data ORDER BY application_date DESC LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT * FROM inpit_data ORDER BY application_date DESC LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT * FROM inpit_data ORDER BY application_date DESC LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">集計関数 (Aggregate Functions)</h3>
            </div>
            <div class="box-body">
                <div class="panel-group" id="accordion-aggregates">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-aggregates" href="#collapse-count">
                                    レコード数のカウント (Count records)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-count" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT COUNT(*) AS record_count FROM inpit_data;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT COUNT(*) AS record_count FROM inpit_data;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT COUNT(*) AS record_count FROM inpit_data;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-aggregates" href="#collapse-group-by">
                                    GROUP BY句を使用した集計 (Aggregate with GROUP BY)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-group-by" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name ORDER BY patent_count DESC LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name ORDER BY patent_count DESC LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name ORDER BY patent_count DESC LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-aggregates" href="#collapse-having">
                                    HAVING句を使った集計結果のフィルタリング (Filter aggregates with HAVING)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-having" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name HAVING patent_count > 5 ORDER BY patent_count DESC;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name HAVING patent_count > 5 ORDER BY patent_count DESC;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT applicant_name, COUNT(*) AS patent_count FROM inpit_data GROUP BY applicant_name HAVING patent_count > 5 ORDER BY patent_count DESC;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">テキスト検索 (Text Search)</h3>
            </div>
            <div class="box-body">
                <div class="panel-group" id="accordion-text-search">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-text-search" href="#collapse-like">
                                    LIKE演算子を使用したワイルドカード検索 (Wildcard search with LIKE)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-like" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT * FROM inpit_data WHERE title LIKE '%ロボット%' LIMIT 10;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT * FROM inpit_data WHERE title LIKE '%ロボット%' LIMIT 10;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT * FROM inpit_data WHERE title LIKE '%ロボット%' LIMIT 10;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">日付関数 (Date Functions)</h3>
            </div>
            <div class="box-body">
                <div class="panel-group" id="accordion-dates">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-dates" href="#collapse-date-year">
                                    年別の出願数 (Applications by year)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-date-year" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT SUBSTR(application_date, 1, 4) as year, COUNT(*) as count FROM inpit_data GROUP BY year ORDER BY year DESC;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT SUBSTR(application_date, 1, 4) as year, COUNT(*) as count FROM inpit_data GROUP BY year ORDER BY year DESC;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT SUBSTR(application_date, 1, 4) as year, COUNT(*) as count FROM inpit_data GROUP BY year ORDER BY year DESC;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion-dates" href="#collapse-date-month">
                                    月別の出願数 (Applications by month)
                                </a>
                            </h4>
                        </div>
                        <div id="collapse-date-month" class="panel-collapse collapse">
                            <div class="panel-body">
                                <pre>SELECT 
    SUBSTR(application_date, 1, 4) as year, 
    SUBSTR(application_date, 6, 2) as month,
    COUNT(*) as count 
FROM inpit_data 
WHERE application_date >= '2020-01-01' 
GROUP BY year, month 
ORDER BY year DESC, month ASC;</pre>
                                <button class="btn btn-sm btn-primary copy-btn" data-query="SELECT SUBSTR(application_date, 1, 4) as year, SUBSTR(application_date, 6, 2) as month, COUNT(*) as count FROM inpit_data WHERE application_date >= '2020-01-01' GROUP BY year, month ORDER BY year DESC, month ASC;">コピー (Copy)</button>
                                <button class="btn btn-sm btn-success run-btn" data-db="inpit" data-query="SELECT SUBSTR(application_date, 1, 4) as year, SUBSTR(application_date, 6, 2) as month, COUNT(*) as count FROM inpit_data WHERE application_date >= '2020-01-01' GROUP BY year, month ORDER BY year DESC, month ASC;">実行 (Run)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="results" class="box">
            <div class="box-header">
                <h3 class="box-title">実行結果 (Results)</h3>
            </div>
            <div class="box-body">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle copy buttons
    document.querySelectorAll('.copy-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const query = this.getAttribute('data-query');
            
            // Create a temporary textarea to copy text
            const textarea = document.createElement('textarea');
            textarea.value = query;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Show feedback
            const originalText = this.textContent;
            this.textContent = 'コピーしました (Copied)!';
            setTimeout(() => {
                this.textContent = originalText;
            }, 1500);
        });
    });
    
    // Handle run buttons
    document.querySelectorAll('.run-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const query = this.getAttribute('data-query');
            const dbType = this.getAttribute('data-db');
            
            // Show a loading indicator
            const resultDiv = document.getElementById('resultContent');
            resultDiv.innerHTML = `<div class="text-center"><i class="fa fa-spinner fa-spin fa-2x"></i><p>実行中 (Executing query)...</p></div>`;
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            // Execute the query
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'query=' + encodeURIComponent(query) + '&db_type=' + encodeURIComponent(dbType)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                if (data.message) {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    return;
                }
                
                // Display results in a table
                let tableHtml = '<div class="table-responsive"><table class="table table-striped table-bordered">';
                tableHtml += '<thead><tr>';
                data.columns.forEach(column => {
                    tableHtml += `<th>${column}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                data.results.forEach(row => {
                    tableHtml += '<tr>';
                    row.forEach(cell => {
                        tableHtml += `<td>${cell === null ? '<em>NULL</em>' : cell}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</tbody></table></div>';
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">クエリが実行されました (Query executed successfully). ${data.results.length} 行のデータが返されました (rows returned).</div>
                    <div class="well well-sm"><pre>${query}</pre></div>
                    ${tableHtml}
                `;
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="alert alert-danger">エラー (Error): ${error}</div>`;
            });
        });
    });
});
</script>
{% endblock %}
