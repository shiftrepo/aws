variables:
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«åˆ†é›¢ï¼‰
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ./.m2/repository/

stages:
  - build
  - test
  - coverage
  - sonar
  - package
  - deploy

####################################
# Backend Pipeline
####################################

.backend_before_script: &backend_before_script
  - echo "ğŸ”§ Mavenè¨­å®šã‚’æº–å‚™ä¸­..."
  - mkdir -p ./.m2
  - |
    cat > ./.m2/settings.xml <<EOF
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
              http://maven.apache.org/xsd/settings-1.0.0.xsd">
      <servers>
        <server>
          <id>nexus-snapshots</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
        <server>
          <id>nexus-releases</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
      </servers>
      <mirrors>
        <mirror>
          <id>nexus</id>
          <mirrorOf>*</mirrorOf>
          <url>http://${EC2_PUBLIC_IP}:8082/repository/maven-public/</url>
        </mirror>
      </mirrors>
    </settings>
    EOF
  - echo "âœ… Mavenè¨­å®šå®Œäº†"

build:
  stage: build
  before_script: *backend_before_script
  script:
    - echo "ğŸ—ï¸ Mavenã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­..."
    - mvn -B -s ./.m2/settings.xml clean compile

test:
  stage: test
  before_script: *backend_before_script
  script:
    - echo "ğŸ§ª JUnit ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
    - mvn -B -s ./.m2/settings.xml test

coverage:
  stage: coverage
  before_script: *backend_before_script
  script:
    - echo "ğŸ“Š JaCoCo ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
    - mvn -B -s ./.m2/settings.xml jacoco:report
  artifacts:
    paths:
      - backend/target/site/jacoco/
    expire_in: 1 week

sonarqube:
  stage: sonar
  before_script: *backend_before_script
  rules:
    # æ‰‹å‹•å®Ÿè¡Œ: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã¾ãŸã¯ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œå¯èƒ½
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: false
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸: å¿…ãšå®Ÿè¡Œ
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"'
      when: on_success
    # é€šå¸¸ã®é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒ: è‡ªå‹•å®Ÿè¡Œ
    - when: on_success
  script:
    - echo "ğŸ” SonarQube Backendè§£æå®Ÿè¡Œä¸­..."
    - |
      # SonarQubeæ¥ç¶šãƒ†ã‚¹ãƒˆ
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"
      echo "ğŸ”— SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ: $SONAR_URL"
      if ! curl -s -f "$SONAR_URL/api/system/status" > /dev/null; then
        echo "âŒ SonarQubeã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: $SONAR_URL"
        exit 1
      fi
      echo "âœ… SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªå®Œäº†"
    - |
      # SonarQubeè§£æå®Ÿè¡Œ
      echo "ğŸ” SonarQubeè§£æå®Ÿè¡Œä¸­..."
      mvn -B -s ./.m2/settings.xml clean verify sonar:sonar \
        -Dsonar.host.url="http://${EC2_PUBLIC_IP}:8000" \
        -Dsonar.login="admin" \
        -Dsonar.password="Degital2026!" \
        -Dsonar.projectKey="sample-app-backend" \
        -Dsonar.projectName="Sample App Backend"
      echo "âœ… SonarQubeè§£æå®Œäº†"
    - |
      # è§£æçµæœç¢ºèª
      echo "ğŸ“Š SonarQubeè§£æçµæœç¢ºèªä¸­..."
      sleep 5  # SonarQubeã§ã®å‡¦ç†å®Œäº†ã‚’å¾…æ©Ÿ

      PROJECT_KEY="sample-app-backend"
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨ç¢ºèª
      if curl -s -u "admin:Degital2026!" "$SONAR_URL/api/projects/search?projects=$PROJECT_KEY" | grep -q "\"key\":\"$PROJECT_KEY\""; then
        echo "âœ… SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ: $PROJECT_KEY"
        echo "ğŸŒ SonarQube Dashboard: $SONAR_URL/dashboard?id=$PROJECT_KEY"
      else
        echo "âš ï¸ SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆç¢ºèªãŒã§ãã¾ã›ã‚“ã§ã—ãŸ"
        echo "ğŸ” æ‰‹å‹•ç¢ºèª: $SONAR_URL/projects"
      fi

package:
  stage: package
  before_script: *backend_before_script
  script:
    - echo "ğŸ“¦ Maven ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ä¸­..."
    - mvn -B -s ./.m2/settings.xml package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
      - common/target/*.jar
    expire_in: 1 week

nexus-deploy:
  stage: deploy
  before_script: *backend_before_script
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - |
      # Nexusæ¥ç¶šç¢ºèª
      NEXUS_URL="http://${EC2_PUBLIC_IP}:8082"
      echo "ğŸ”— Nexusæ¥ç¶šç¢ºèª: $NEXUS_URL"
      if ! curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null; then
        echo "âŒ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
      fi
      echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"
    - mvn -B -s ./.m2/settings.xml deploy -DskipTests
    - echo "âœ… Nexus ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

container-deploy:
  stage: deploy
  before_script:
    - echo "ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ä¸­..."
  script:
    - echo "ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - bash ./scripts/deploy-containers.sh
  needs:
    - job: package
      artifacts: true
    - nexus-deploy

