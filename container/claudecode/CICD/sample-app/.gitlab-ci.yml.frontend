# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«åˆ†é›¢ï¼‰
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

stages:
  - install
  - lint
  - test
  - sonar
  - build
  - nexus-deploy

####################################
# Frontend Pipeline
####################################

frontend-install:
  stage: install
  before_script:
    - echo "ğŸ“¦ Frontendä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

frontend-lint:
  stage: lint
  before_script:
    - echo "ğŸ” ESLintå®Ÿè¡Œä¸­..."
  script:
    - npm run lint:ci
  needs: [frontend-install]

frontend-test:
  stage: test
  before_script:
    - echo "ğŸ§ª Jest + Coverageå®Ÿè¡Œä¸­..."
  script:
    - npm run test:ci
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 1 week
  needs: [frontend-install]

frontend-sonarqube:
  stage: sonar
  before_script:
    - echo "ğŸ” SonarQube Frontendè§£æå®Ÿè¡Œä¸­..."
  rules:
    # æ‰‹å‹•å®Ÿè¡Œ: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã¾ãŸã¯ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œå¯èƒ½
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
    # é€šå¸¸: è‡ªå‹•å®Ÿè¡Œ
    - when: on_success
      allow_failure: true
  script:
    - |
      # sonar-scannerã‚’npmçµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      if ! command -v sonar-scanner &> /dev/null; then
        echo "ğŸ“¥ sonar-scannerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm install -g sonarqube-scanner
      fi
    - |
      # SonarQubeè§£æå®Ÿè¡Œ (React + Jest standard - LCOV only)
      sonar-scanner \
        -Dsonar.host.url="http://${EC2_PUBLIC_IP}:8000" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.projectKey="sample-app-frontend" \
        -Dsonar.projectName="Sample App Frontend" \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.test.jsx,**/*.spec.jsx" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
  needs: [frontend-test]

frontend-build:
  stage: build
  before_script:
    - echo "ğŸ—ï¸ Viteãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  needs:
    - frontend-lint
    - frontend-test

frontend-nexus-deploy:
  stage: nexus-deploy
  before_script:
    - echo "ğŸ“¦ Frontendæˆæœç‰©ã‚’Nexusã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
  script:
    - |
      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ï¼ˆæœ€æ–°ç‰ˆã¨ã—ã¦å›ºå®šåã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
      VERSION="latest"
      ARTIFACT_NAME="frontend-${VERSION}.tar.gz"

      # dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’tar.gzå½¢å¼ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ: ${ARTIFACT_NAME}"
      tar -czf ${ARTIFACT_NAME} -C dist/ .

      # Nexus raw-hostedãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      echo "ğŸš€ Nexusã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: http://${EC2_PUBLIC_IP}:8082/repository/raw-hosted/frontend/${ARTIFACT_NAME}"
      curl -v -u admin:Degital2026! \
        --upload-file ${ARTIFACT_NAME} \
        "http://${EC2_PUBLIC_IP}:8082/repository/raw-hosted/frontend/${ARTIFACT_NAME}"

      echo "âœ… Frontendæˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
  needs:
    - job: frontend-build
      artifacts: true

