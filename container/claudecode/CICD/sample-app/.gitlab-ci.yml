# GitLab CI/CD Pipeline Configuration
# 6ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³: build â†’ test â†’ coverage â†’ sonarqube â†’ package â†’ deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
cache:
  paths:
    - .m2/repository/
    - backend/target/

stages:
  - build
  - test
  - coverage
  - sonarqube
  - package
  - deploy

# 1. ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
build:
  stage: build
  script:
    - echo "ğŸ—ï¸ Maven ãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    - mvn $MAVEN_CLI_OPTS clean compile
    - echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"
  artifacts:
    paths:
      - backend/target/classes/
      - common/target/classes/
    expire_in: 1 hour
  only:
    - branches

# 2. ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸
test:
  stage: test
  script:
    - echo "ğŸ§ª JUnit ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    - mvn $MAVEN_CLI_OPTS test
    - echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"
  artifacts:
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
    paths:
      - backend/target/surefire-reports/
      - backend/target/jacoco.exec
    expire_in: 1 hour
  only:
    - branches

# 3. ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¹ãƒ†ãƒ¼ã‚¸
coverage:
  stage: coverage
  script:
    - echo "ğŸ“Š JaCoCo ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
    - mvn $MAVEN_CLI_OPTS jacoco:report
    - echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚’ç¢ºèªä¸­..."

    # ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã®è¡¨ç¤º
    - |
      if [ -f "backend/target/site/jacoco/index.html" ]; then
        echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
        # XMLãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’æŠ½å‡º
        if [ -f "backend/target/site/jacoco/jacoco.xml" ]; then
          LINE_COVERAGE=$(grep -o 'type="LINE".*missed="[0-9]*".*covered="[0-9]*"' backend/target/site/jacoco/jacoco.xml | head -1 | sed 's/.*covered="\([0-9]*\)".*/\1/')
          LINE_MISSED=$(grep -o 'type="LINE".*missed="[0-9]*".*covered="[0-9]*"' backend/target/site/jacoco/jacoco.xml | head -1 | sed 's/.*missed="\([0-9]*\)".*/\1/')
          if [ -n "$LINE_COVERAGE" ] && [ -n "$LINE_MISSED" ]; then
            TOTAL_LINES=$((LINE_COVERAGE + LINE_MISSED))
            if [ $TOTAL_LINES -gt 0 ]; then
              COVERAGE_PERCENT=$((LINE_COVERAGE * 100 / TOTAL_LINES))
              echo "ğŸ¯ è¡Œã‚«ãƒãƒ¬ãƒƒã‚¸: ${COVERAGE_PERCENT}% (${LINE_COVERAGE}/${TOTAL_LINES})"
            fi
          fi
        fi
      else
        echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
      fi

    - echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æå®Œäº†"
  dependencies:
    - test
  artifacts:
    reports:
      coverage_report:
        coverage_format: jacoco
        path: backend/target/site/jacoco/jacoco.xml
    paths:
      - backend/target/site/jacoco/
    expire_in: 1 week
  only:
    - branches

# 4. SonarQubeã‚¹ãƒ†ãƒ¼ã‚¸
sonarqube:
  stage: sonarqube
  script:
    - echo "ğŸ” SonarQube é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
    - echo "SonarQube Host: ${SONAR_HOST_URL:-http://localhost:8000}"
    - echo "Project Key: ${SONAR_PROJECT_KEY:-sample-app-backend}"

    # SonarQubeãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª
    - |
      if [ -z "$SONAR_TOKEN" ]; then
        echo "âŒ SONAR_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "GitLab Settings â†’ CI/CD â†’ Variables ã§SOnar_TOKENã‚’è¨­å®šã—ã¦ãã ã•ã„"
        exit 1
      fi

    # SonarQubeè§£æå®Ÿè¡Œ
    - |
      mvn $MAVEN_CLI_OPTS sonar:sonar \
        -Dsonar.host.url=${SONAR_HOST_URL:-http://localhost:8000} \
        -Dsonar.projectKey=${SONAR_PROJECT_KEY:-sample-app-backend} \
        -Dsonar.projectName="Sample App Backend" \
        -Dsonar.token=$SONAR_TOKEN \
        -Dsonar.coverage.jacoco.xmlReportPaths=backend/target/site/jacoco/jacoco.xml \
        -Dsonar.junit.reportPaths=backend/target/surefire-reports \
        -Dsonar.sources=backend/src/main/java,common/src/main/java \
        -Dsonar.tests=backend/src/test/java \
        -Dsonar.java.binaries=backend/target/classes,common/target/classes

    - echo "âœ… SonarQube è§£æå®Œäº†"
    - echo "ğŸŒ SonarQube Dashboard: ${SONAR_HOST_URL:-http://localhost:8000}/dashboard?id=${SONAR_PROJECT_KEY:-sample-app-backend}"
  dependencies:
    - coverage
  allow_failure: false
  only:
    - branches

# 5. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¹ãƒ†ãƒ¼ã‚¸
package:
  stage: package
  script:
    - echo "ğŸ“¦ JARãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸­..."
    - mvn $MAVEN_CLI_OPTS package -DskipTests
    - echo "âœ… ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å®Œäº†"

    # ç”Ÿæˆã•ã‚ŒãŸJARãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    - |
      if [ -f "backend/target/sample-app-backend-1.0.0-SNAPSHOT.jar" ]; then
        echo "âœ… Spring Boot JAR: backend/target/sample-app-backend-1.0.0-SNAPSHOT.jar"
        ls -lh backend/target/*.jar
      else
        echo "âŒ JARãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
      fi
  dependencies:
    - sonarqube
  artifacts:
    paths:
      - backend/target/*.jar
      - common/target/*.jar
    expire_in: 1 week
  only:
    - branches

# 6. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆmasterãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
deploy:
  stage: deploy
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."

    # CIç”¨Maven settings.xmlç”Ÿæˆ
    - |
      if [ ! -f ".ci-settings.xml.template" ]; then
        echo "âŒ .ci-settings.xml.template ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
      fi

      # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç½®æ›
      sed "s|__NEXUS_PASSWORD__|${NEXUS_ADMIN_PASSWORD}|g" .ci-settings.xml.template > .ci-settings.xml

      # EC2_PUBLIC_IPãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç½®æ›
      if [ -n "$EC2_PUBLIC_IP" ]; then
        sed -i "s|localhost|${EC2_PUBLIC_IP}|g" .ci-settings.xml
      fi

    # Nexusæ¥ç¶šç¢ºèª
    - |
      NEXUS_URL="http://${EC2_PUBLIC_IP:-localhost}:8082"
      echo "Nexus URL: $NEXUS_URL"

      if ! curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null; then
        echo "âš ï¸ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "URL: $NEXUS_URL"
        echo "è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        exit 1
      fi
      echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"

    # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
    - mvn $MAVEN_CLI_OPTS deploy -DskipTests --settings .ci-settings.xml
    - echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
    - echo "ğŸŒ Nexus Repository: http://${EC2_PUBLIC_IP:-localhost}:8082/#browse/browse:maven-snapshots"
  dependencies:
    - package
  only:
    - master
    - main

# å“è³ªã‚²ãƒ¼ãƒˆè¨­å®šï¼ˆå¾Œã§å®Ÿè£…ï¼‰
# quality_gate:
#   stage: quality_gate
#   script:
#     - echo "å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè£…äºˆå®š"
#   when: manual
#   only:
#     - master