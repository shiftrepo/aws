# GitLab CI/CD Pipeline Configuration
# 5ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³: build â†’ test â†’ coverage â†’ package â†’ deploy
# ä¿®æ­£æ¸ˆã¿: Jakarta EE imports, Maven local repository, rules syntax

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version --settings ./.m2/settings.xml"

# å…¨ã‚¹ãƒ†ãƒ¼ã‚¸å…±é€šã®Mavenè¨­å®šï¼ˆåŒ¿åã‚¢ã‚¯ã‚»ã‚¹æœ‰åŠ¹ï¼‰
before_script:
  - echo "ğŸ”§ Mavenè¨­å®šã‚’æº–å‚™ä¸­ï¼ˆåŒ¿åã‚¢ã‚¯ã‚»ã‚¹ï¼‰..."
  - |
    mkdir -p ./.m2
    cat > ./.m2/settings.xml << EOF
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
              http://maven.apache.org/xsd/settings-1.0.0.xsd">
      <mirrors>
        <mirror>
          <id>nexus-mirror</id>
          <mirrorOf>*</mirrorOf>
          <url>http://${EC2_PUBLIC_IP:-localhost}:8082/repository/maven-public/</url>
        </mirror>
      </mirrors>
    </settings>
    EOF
  - echo "âœ… Mavenè¨­å®šå®Œäº†ï¼ˆNexusåŒ¿åã‚¢ã‚¯ã‚»ã‚¹: ${EC2_PUBLIC_IP:-localhost}:8082ï¼‰"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
cache:
  paths:
    - ./.m2/repository/
    - backend/target/

stages:
  - build
  - test
  - coverage
  - sonarqube
  - package
  - deploy

# 1. ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
build:
  stage: build
  script:
    - echo "ğŸ—ï¸ Maven ãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    - mvn $MAVEN_CLI_OPTS clean compile
    - echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"
  artifacts:
    paths:
      - backend/target/classes/
      - common/target/classes/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# 2. ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸
test:
  stage: test
  script:
    - echo "ğŸ§ª JUnit ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    - mvn $MAVEN_CLI_OPTS test
    - echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"
  artifacts:
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
    paths:
      - backend/target/surefire-reports/
      - backend/target/jacoco.exec
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# 3. ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¹ãƒ†ãƒ¼ã‚¸
coverage:
  stage: coverage
  script:
    - echo "ğŸ“Š JaCoCo ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
    - mvn $MAVEN_CLI_OPTS jacoco:report
    - echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚’ç¢ºèªä¸­..."
    - ls -la backend/target/site/jacoco/ || echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    - echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æå®Œäº†"
  dependencies:
    - test
  artifacts:
    reports:
      coverage_report:
        coverage_format: jacoco
        path: backend/target/site/jacoco/jacoco.xml
    paths:
      - backend/target/site/jacoco/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# 4. SonarQubeã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œå®Œå…¨ç‰ˆï¼‰
sonarqube:
  stage: sonarqube
  script:
    - echo "ğŸ” SonarQube é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
    - echo "SonarQube Host ${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP:-localhost}:8000}"
    - echo "Project Key ${SONAR_PROJECT_KEY:-sample-app-backend}"
    - |
      if [ -z "$SONAR_TOKEN" ]; then
        echo "âŒ SONAR_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "GitLab Settings â†’ CI/CD â†’ Variables ã§SONAR_TOKENã‚’è¨­å®šã—ã¦ãã ã•ã„"
        exit 1
      fi
    - |
      # SonarQubeæ¥ç¶šãƒ†ã‚¹ãƒˆ
      SONAR_URL="${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP:-localhost}:8000}"
      echo "ğŸ”— SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ: $SONAR_URL"
      if ! curl -s -f "$SONAR_URL/api/system/status" > /dev/null; then
        echo "âŒ SonarQubeã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: $SONAR_URL"
        exit 1
      fi
      echo "âœ… SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªå®Œäº†"
    - |
      # ãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨SonarQubeå®Ÿè¡Œ
      mvn $MAVEN_CLI_OPTS sonar:sonar \
        -Dsonar.host.url="${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP:-localhost}:8000}" \
        -Dsonar.projectKey="${SONAR_PROJECT_KEY:-sample-app-backend}" \
        -Dsonar.projectName="Sample App Multi-Module" \
        -Dsonar.token="$SONAR_TOKEN" \
        -Dsonar.coverage.jacoco.xmlReportPaths="backend/target/site/jacoco/jacoco.xml" \
        -Dsonar.java.binaries="backend/target/classes,common/target/classes" \
        -Dsonar.sources="backend/src/main/java,common/src/main/java" \
        -Dsonar.tests="backend/src/test/java" \
        -Dsonar.java.test.binaries="backend/target/test-classes"
    - echo "âœ… SonarQube è§£æå®Œäº†"
    - echo "ğŸŒ SonarQube Dashboard ${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP:-localhost}:8000}/dashboard?id=${SONAR_PROJECT_KEY:-sample-app-backend}"
  dependencies:
    - coverage
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# 5. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¹ãƒ†ãƒ¼ã‚¸
package:
  stage: package
  script:
    - echo "ğŸ“¦ JARãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸­..."
    - mvn $MAVEN_CLI_OPTS package -DskipTests
    - echo "âœ… ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å®Œäº†"
    - ls -lh backend/target/*.jar || echo "JARãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  dependencies:
    - coverage
  artifacts:
    paths:
      - backend/target/*.jar
      - common/target/*.jar
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# 6. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆmasterãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
deploy:
  stage: deploy
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - |
      if [ ! -f ".ci-settings.xml.template" ]; then
        echo "âŒ .ci-settings.xml.template ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
      fi
    - sed "s|__NEXUS_PASSWORD__|${NEXUS_ADMIN_PASSWORD}|g" .ci-settings.xml.template > .ci-settings.xml
    - |
      if [ -n "$EC2_PUBLIC_IP" ]; then
        sed -i "s|localhost|${EC2_PUBLIC_IP}|g" .ci-settings.xml
      fi
    - NEXUS_URL="http://${EC2_PUBLIC_IP:-localhost}:8082"
    - echo "Nexus URL $NEXUS_URL"
    - curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null || (echo "âš ï¸ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ" && exit 1)
    - echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"
    - mvn $MAVEN_CLI_OPTS deploy -DskipTests --settings .ci-settings.xml
    - echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
    - echo "ğŸŒ Nexus Repository http://${EC2_PUBLIC_IP:-localhost}:8082/#browse/browse:maven-snapshots"
  dependencies:
    - package
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "main"