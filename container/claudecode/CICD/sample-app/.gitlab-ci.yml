variables:
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"

cache:
  paths:
    - ./.m2/repository/
    - backend/target/

before_script:
  - echo "ğŸ”§ Mavenè¨­å®šã‚’æº–å‚™ä¸­..."
  - mkdir -p ./.m2
  - |
    cat > ./.m2/settings.xml << 'XMLEOF'
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
              http://maven.apache.org/xsd/settings-1.0.0.xsd">
      <mirrors>
        <mirror>
          <id>nexus-mirror</id>
          <mirrorOf>*</mirrorOf>
          <url>http://13.219.95.96:8082/repository/maven-public/</url>
        </mirror>
      </mirrors>
    </settings>
    XMLEOF
  - echo "âœ… Mavenè¨­å®šå®Œäº†"

stages:
  - build
  - test
  - coverage
  - sonarqube
  - package
  - deploy

build:
  stage: build
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml clean compile

test:
  stage: test
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml test

coverage:
  stage: coverage
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml jacoco:report

sonarqube:
  stage: sonarqube  
  script:
    - echo "SonarQube test"

package:
  stage: package
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml package -DskipTests

deploy:
  stage: deploy
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - |
      if [ ! -f ".ci-settings.xml.template" ]; then
        echo "âŒ .ci-settings.xml.template ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
      fi
    - sed "s|__NEXUS_PASSWORD__|${NEXUS_ADMIN_PASSWORD}|g" .ci-settings.xml.template > .ci-settings.xml
    - NEXUS_URL="http://13.219.95.96:8082"
    - echo "Nexus URL $NEXUS_URL"
    - curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null || (echo "âš ï¸ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ" && exit 1)
    - echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"
    - mvn -B -e -fae -V deploy -DskipTests --settings .ci-settings.xml
    - echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
