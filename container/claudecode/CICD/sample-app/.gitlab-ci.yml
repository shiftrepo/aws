variables:
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"
  EC2_PUBLIC_IP: "13.219.95.96"

cache:
  paths:
    - ./.m2/repository/
    - backend/target/

before_script:
  - echo "ğŸ”§ Mavenè¨­å®šã‚’æº–å‚™ä¸­..."
  - mkdir -p ./.m2
  - |
    cat > ./.m2/settings.xml << XMLEOF
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
              http://maven.apache.org/xsd/settings-1.0.0.xsd">
      <servers>
        <server>
          <id>nexus-snapshots</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
        <server>
          <id>nexus-releases</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
      </servers>
      <mirrors>
        <mirror>
          <id>nexus-mirror</id>
          <mirrorOf>*</mirrorOf>
          <url>http://${EC2_PUBLIC_IP}:8082/repository/maven-public/</url>
        </mirror>
      </mirrors>
    </settings>
    XMLEOF
  - echo "âœ… Mavenè¨­å®šå®Œäº†"

stages:
  - build
  - test
  - coverage
  - sonarqube
  - package
  - deploy

build:
  stage: build
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml clean compile

test:
  stage: test
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml test

coverage:
  stage: coverage
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml jacoco:report

sonarqube:
  stage: sonarqube
  script:
    - echo "ğŸ” SonarQube é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
    - echo "SonarQube Host ${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP}:8000}"
    - echo "Project Key ${SONAR_PROJECT_KEY:-sample-org-management}"
    - |
      if [ -z "$SONAR_TOKEN" ]; then
        echo "âŒ SONAR_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "GitLab Settings â†’ CI/CD â†’ Variables ã§SONAR_TOKENã‚’è¨­å®šã—ã¦ãã ã•ã„"
        exit 1
      fi

      # ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚å…ˆé ­ã®ã¿è¡¨ç¤ºï¼‰
      echo "ğŸ”‘ SONAR_TOKENå½¢å¼ç¢ºèª: $(echo $SONAR_TOKEN | head -c 15)..."

      # SonarQubeèªè¨¼ãƒ†ã‚¹ãƒˆ
      echo "ğŸ” SonarQubeèªè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
      if curl -s -u "admin:Degital2026!" "http://${EC2_PUBLIC_IP}:8000/api/authentication/validate" | grep -q '"valid":true'; then
        echo "âœ… SonarQubeç®¡ç†è€…èªè¨¼æˆåŠŸ"
      else
        echo "âš ï¸ SonarQubeç®¡ç†è€…èªè¨¼å¤±æ•—"
      fi
    - |
      # SonarQubeæ¥ç¶šãƒ†ã‚¹ãƒˆ
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"
      echo "ğŸ”— SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ: $SONAR_URL"
      if ! curl -s -f "$SONAR_URL/api/system/status" > /dev/null; then
        echo "âŒ SonarQubeã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: $SONAR_URL"
        exit 1
      fi
      echo "âœ… SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªå®Œäº†"
    - |
      # SonarQubeè§£æå®Ÿè¡Œ
      echo "ğŸ” SonarQubeè§£æå®Ÿè¡Œä¸­..."
      set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«åœæ­¢

      # âš ï¸ å¤‰æ›´ç¦æ­¢: clean verify sonar:sonar ã‚’åŒã˜Jobã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§
      # target/classes ã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãŒç¢ºå®Ÿã«ç”Ÿæˆã•ã‚Œã‚‹
      if mvn -B -s ./.m2/settings.xml clean verify sonar:sonar \
        -Dsonar.host.url="http://${EC2_PUBLIC_IP}:8000" \
        -Dsonar.login="admin" \
        -Dsonar.password="Degital2026!" \
        -Dsonar.projectKey="sample-org-management"; then
        echo "âœ… SonarQubeè§£æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
      else
        echo "âŒ SonarQubeè§£æãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "èªè¨¼æƒ…å ±ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        exit 1
      fi
    - echo "âœ… SonarQube è§£æå®Œäº†"
    - |
      # è§£æçµæœç¢ºèª
      echo "ğŸ“Š SonarQubeè§£æçµæœç¢ºèªä¸­..."
      sleep 5  # SonarQubeã§ã®å‡¦ç†å®Œäº†ã‚’å¾…æ©Ÿ

      PROJECT_KEY="sample-org-management"
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨ç¢ºèª
      if curl -s -u "admin:Degital2026!" "$SONAR_URL/api/projects/search?projects=$PROJECT_KEY" | grep -q "\"key\":\"$PROJECT_KEY\""; then
        echo "âœ… SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ: $PROJECT_KEY"
        echo "ğŸŒ SonarQube Dashboard: http://${EC2_PUBLIC_IP}:8000/dashboard?id=$PROJECT_KEY"
      else
        echo "âš ï¸ SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆç¢ºèªãŒã§ãã¾ã›ã‚“ã§ã—ãŸ"
        echo "ğŸ” æ‰‹å‹•ç¢ºèª: http://${EC2_PUBLIC_IP}:8000/projects"
      fi

package:
  stage: package
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml package -DskipTests

deploy:
  stage: deploy
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - NEXUS_URL="http://${EC2_PUBLIC_IP}:8082"
    - echo "Nexus URL $NEXUS_URL"
    - curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null || (echo "âš ï¸ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ" && exit 1)
    - echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"
    - mvn -B -e -fae -V deploy -DskipTests -s ./.m2/settings.xml
    - echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
