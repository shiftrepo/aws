variables:
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"
  # EC2_PUBLIC_IP ã¯ GitLab CI/CD Variables ã§è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™ï¼ˆsetup-sample-app.shçµŒç”±ï¼‰

cache:
  - key: backend
    paths:
      - ./.m2/repository/
      - backend/target/
  - key: frontend
    paths:
      - frontend/node_modules/

stages:
  - frontend-install
  - frontend-lint
  - frontend-test
  - frontend-sonarqube
  - frontend-build
  - build
  - test
  - coverage
  - sonarqube
  - package
  - deploy

# ============================================
# Frontend Pipeline (å®Ÿè¡Œå¥‘æ©Ÿ: frontend/**å¤‰æ›´æ™‚)
# ============================================

frontend-install:
  stage: frontend-install
  before_script:
    - echo "ğŸ“¦ Frontendä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
  script:
    - cd frontend
    - npm ci
  cache:
    key: frontend
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
  artifacts:
    paths:
      - frontend/node_modules/
    expire_in: 1 hour

frontend-lint:
  stage: frontend-lint
  before_script:
    - echo "ğŸ” ESLintå®Ÿè¡Œä¸­..."
  script:
    - cd frontend
    - npm run lint:ci
  only:
    changes:
      - frontend/**/*
  needs:
    - frontend-install

frontend-test:
  stage: frontend-test
  before_script:
    - echo "ğŸ§ª Jest + Coverageå®Ÿè¡Œä¸­..."
  script:
    - cd frontend
    - npm run test:ci
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    paths:
      - frontend/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
    expire_in: 1 week
  only:
    changes:
      - frontend/**/*
  needs:
    - frontend-install

frontend-sonarqube:
  stage: frontend-sonarqube
  before_script:
    - echo "ğŸ” SonarQube Frontendè§£æå®Ÿè¡Œä¸­..."
  script:
    - cd frontend
    - |
      # SonarScannerå®Ÿè¡Œï¼ˆæ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‰æï¼‰
      if command -v sonar-scanner >/dev/null 2>&1; then
        sonar-scanner \
          -Dsonar.host.url="http://${EC2_PUBLIC_IP}:8000" \
          -Dsonar.login="admin" \
          -Dsonar.password="Degital2026!"
      else
        echo "âš ï¸ SonarScannerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
        echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: npm install -g sonarqube-scanner"
      fi
  only:
    changes:
      - frontend/**/*
  needs:
    - frontend-test
  allow_failure: true

frontend-build:
  stage: frontend-build
  before_script:
    - echo "ğŸ—ï¸ Viteãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
  script:
    - cd frontend
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  only:
    changes:
      - frontend/**/*
  needs:
    - frontend-test

# ============================================
# Backend Pipeline (å®Ÿè¡Œå¥‘æ©Ÿ: backend/**å¤‰æ›´æ™‚)
# ============================================

.backend_before_script: &backend_before_script
  - echo "ğŸ”§ Mavenè¨­å®šã‚’æº–å‚™ä¸­..."
  - mkdir -p ./.m2
  - |
    cat > ./.m2/settings.xml << XMLEOF
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
              http://maven.apache.org/xsd/settings-1.0.0.xsd">
      <servers>
        <server>
          <id>nexus-snapshots</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
        <server>
          <id>nexus-releases</id>
          <username>admin</username>
          <password>Degital2026!</password>
        </server>
      </servers>
      <mirrors>
        <mirror>
          <id>nexus-mirror</id>
          <mirrorOf>*</mirrorOf>
          <url>http://${EC2_PUBLIC_IP}:8082/repository/maven-public/</url>
        </mirror>
      </mirrors>
    </settings>
    XMLEOF
  - echo "âœ… Mavenè¨­å®šå®Œäº†"

build:
  stage: build
  before_script: *backend_before_script
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml clean compile
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

test:
  stage: test
  before_script: *backend_before_script
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml test
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

coverage:
  stage: coverage
  before_script: *backend_before_script
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml jacoco:report
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

sonarqube:
  stage: sonarqube
  before_script: *backend_before_script
  script:
    - echo "ğŸ” SonarQube é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
    - echo "SonarQube Host ${SONAR_HOST_URL:-http://${EC2_PUBLIC_IP}:8000}"
    - echo "Project Key ${SONAR_PROJECT_KEY:-sample-org-management}"
    - |
      # SonarQubeèªè¨¼ãƒ†ã‚¹ãƒˆ
      echo "ğŸ” SonarQubeèªè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
      if curl -s -u "admin:Degital2026!" "http://${EC2_PUBLIC_IP}:8000/api/authentication/validate" | grep -q '"valid":true'; then
        echo "âœ… SonarQubeç®¡ç†è€…èªè¨¼æˆåŠŸ"
      else
        echo "âš ï¸ SonarQubeç®¡ç†è€…èªè¨¼å¤±æ•—"
      fi
    - |
      # SonarQubeæ¥ç¶šãƒ†ã‚¹ãƒˆ
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"
      echo "ğŸ”— SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ: $SONAR_URL"
      if ! curl -s -f "$SONAR_URL/api/system/status" > /dev/null; then
        echo "âŒ SonarQubeã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: $SONAR_URL"
        exit 1
      fi
      echo "âœ… SonarQubeã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªå®Œäº†"
    - |
      # SonarQubeè§£æå®Ÿè¡Œ
      echo "ğŸ” SonarQubeè§£æå®Ÿè¡Œä¸­..."
      set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«åœæ­¢

      # âš ï¸ å¤‰æ›´ç¦æ­¢: clean verify sonar:sonar ã‚’åŒã˜Jobã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§
      # target/classes ã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãŒç¢ºå®Ÿã«ç”Ÿæˆã•ã‚Œã‚‹
      if mvn -B -s ./.m2/settings.xml clean verify sonar:sonar \
        -Dsonar.host.url="http://${EC2_PUBLIC_IP}:8000" \
        -Dsonar.login="admin" \
        -Dsonar.password="Degital2026!" \
        -Dsonar.projectKey="sample-org-management"; then
        echo "âœ… SonarQubeè§£æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
      else
        echo "âŒ SonarQubeè§£æãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "èªè¨¼æƒ…å ±ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        exit 1
      fi
    - echo "âœ… SonarQube è§£æå®Œäº†"
    - |
      # è§£æçµæœç¢ºèª
      echo "ğŸ“Š SonarQubeè§£æçµæœç¢ºèªä¸­..."
      sleep 5  # SonarQubeã§ã®å‡¦ç†å®Œäº†ã‚’å¾…æ©Ÿ

      PROJECT_KEY="sample-org-management"
      SONAR_URL="http://${EC2_PUBLIC_IP}:8000"

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨ç¢ºèª
      if curl -s -u "admin:Degital2026!" "$SONAR_URL/api/projects/search?projects=$PROJECT_KEY" | grep -q "\"key\":\"$PROJECT_KEY\""; then
        echo "âœ… SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ: $PROJECT_KEY"
        echo "ğŸŒ SonarQube Dashboard: http://${EC2_PUBLIC_IP}:8000/dashboard?id=$PROJECT_KEY"
      else
        echo "âš ï¸ SonarQubeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆç¢ºèªãŒã§ãã¾ã›ã‚“ã§ã—ãŸ"
        echo "ğŸ” æ‰‹å‹•ç¢ºèª: http://${EC2_PUBLIC_IP}:8000/projects"
      fi
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

package:
  stage: package
  before_script: *backend_before_script
  script:
    - mvn -B -e -fae -V -s ./.m2/settings.xml package -DskipTests
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

nexus-deploy:
  stage: deploy
  before_script: *backend_before_script
  script:
    - echo "ğŸš€ Nexus Repository ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - NEXUS_URL="http://${EC2_PUBLIC_IP}:8082"
    - echo "Nexus URL $NEXUS_URL"
    - curl -f -s "$NEXUS_URL/service/rest/v1/status" > /dev/null || (echo "âš ï¸ Nexus Repository ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ" && exit 1)
    - echo "âœ… Nexus Repository æ¥ç¶šç¢ºèªå®Œäº†"
    - mvn -B -e -fae -V deploy -DskipTests -s ./.m2/settings.xml
    - echo "âœ… Nexus ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*

container-deploy:
  stage: deploy
  before_script:
    - echo "ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ä¸­..."
  script:
    - echo "ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
    - export EC2_PUBLIC_IP="${EC2_PUBLIC_IP}"
    - export POSTGRES_HOST="cicd-postgres"
    - export POSTGRES_PORT="5432"
    - export POSTGRES_DB="sampledb"
    - export POSTGRES_USER="sampleuser"
    - export POSTGRES_PASSWORD="Degital2026!"
    - bash ./scripts/deploy-containers.sh
    - echo "âœ… ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
  only:
    changes:
      - backend/**/*
      - pom.xml
      - common/**/*
  needs:
    - nexus-deploy
