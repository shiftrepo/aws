# ユーザーガイド: Java テスト仕様書生成ツール

## 目次
1. [はじめに](#はじめに)
2. [インストール](#インストール)
3. [初回セットアップ](#初回セットアップ)
4. [基本操作](#基本操作)
5. [高度な機能](#高度な機能)
6. [トラブルシューティング](#トラブルシューティング)
7. [ベストプラクティス](#ベストプラクティス)

## はじめに

### このツールの機能
Java テスト仕様書生成ツールは以下の処理を自動実行して、包括的なExcelベースのテスト仕様書を作成します：
- **Javaテストファイルの解析**: カスタムアノテーションを自動抽出
- **テストケース情報の取得**: 目的、手順、期待結果などを抽出
- **JaCoCoカバレッジレポートの分析**: C1（条件判定）カバレッジを解析
- **プロフェッショナルなExcelレポートの生成**: 複数シートでの分析結果出力

### 対象ユーザー
- **QAエンジニア**: テストケースとカバレッジの文書化
- **テストマネージャー**: テスト仕様書レポートの作成
- **開発チーム**: テストカバレッジメトリクスの追跡
- **プロジェクトマネージャー**: 成果物のためのテスト文書生成

### 事前準備
以下を確認してください：
- **Microsoft Excel 2016以降**: VBA有効化必須
- **Javaテストファイル**: 適切なアノテーション付き（[アノテーション標準](annotation-standards.md)参照）
- **JaCoCoカバレッジレポート**: オプション、カバレッジ分析用
- **書き込み権限**: 出力ディレクトリへの書き込み権限

## インストール

### ステップ 1: プロジェクトファイルのダウンロード
1. 全プロジェクトファイルをローカルシステムにダウンロード
2. 推奨場所: `C:\Tools\JavaTestSpecGenerator\`
3. 全サブディレクトリとファイルが保持されていることを確認

### ステップ 2: Excelアプリケーションの作成
1. 詳細な[VBAインポート手順](../vba-modules/VBA-Import-Instructions.md)に従う
2. メインプロジェクトディレクトリに`TestSpecGenerator.xlsm`を作成
3. 指定された順序で6つのVBAモジュールをすべてインポート

### ステップ 3: Excelセキュリティの設定
1. **開発者タブの有効化**: ファイル → オプション → リボンのユーザー設定 → 「開発」にチェック
2. **マクロセキュリティ**: ファイル → オプション → セキュリティセンター → セキュリティセンターの設定 → マクロの設定
3. **設定選択**: 「警告を表示してすべてのマクロを無効にする」（推奨）または「すべてのマクロを有効にする」（開発時のみ）

## 初回セットアップ

### サンプルデータでのテスト
実際のプロジェクトで使用する前に、付属のサンプルファイルでツールをテスト：

1. **TestSpecGenerator.xlsmを開く**
2. **プロンプトが表示されたらマクロを有効化**
3. **「Generate Test Specification」ボタンをクリック**
4. **テスト実行の設定**:
   - **ソースディレクトリ**: `[プロジェクトパス]\sample-java-tests`
   - **出力ファイル**: `[プロジェクトパス]\examples\sample-output\TestSpec_Sample.xlsx`
5. **OKをクリック**して処理開始
6. **生成されたExcelファイルで結果を確認**

サンプルデータからの期待結果：
- **2つのJavaテストファイル**を処理
- **6つのテストメソッド**を発見
- **8つのテストケース**（アノテーション付き）
- **94.6% C1カバレッジ**（サンプルJaCoCoレポートより）

### サンプル出力の理解
生成されるExcelファイルの内容：

#### Test Details シート
- `BasicCalculatorTest.java`と`StringValidatorTest.java`からの完全なアノテーションデータ
- JaCoCoレポートにリンクされたカバレッジ率
- 作成者、日付、修正追跡情報

#### Summary シート
- **2ファイル処理**、**8テストケース発見**
- **全体94.6%ブランチカバレッジ**
- **148ブランチ中140ブランチカバー**
- 処理時間と統計情報

#### Coverage シート
- メソッドレベルのカバレッジ分析
- 詳細なブランチと命令メトリクス
- カバレッジステータス指標

#### Configuration シート
- 処理設定とメタデータ
- ファイルパスとタイムスタンプ
- アプリケーションバージョン情報

## 基本操作

### アプリケーションの開始

#### 方法 1: ボタンクリック（推奨）
1. `TestSpecGenerator.xlsm`を開く
2. プロンプトが表示されたらマクロを有効化
3. シート上の「Generate Test Specification」ボタンをクリック

#### 方法 2: VBAエディタ
1. `Alt + F11`でVBAエディタを開く
2. `F5`またはRun → Run Sub/UserFormをクリック
3. `MainController.GenerateTestSpecification`を選択
4. Runをクリック

#### 方法 3: リボンコマンド（設定済みの場合）
1. セットアップ時に追加したカスタムリボンボタンを使用
2. カスタム「Generate Test Spec」ボタンをクリック

### 設定ダイアログ

ツールを実行すると、2つの入力ダイアログが表示されます：

#### ソースディレクトリ入力
```
Javaテストファイルを含むソースディレクトリを入力してください:
[C:\Projects\MyProject\src\test\java]
```
- **フルパスを入力**: Javaテストファイルを含むディレクトリへのフルパス
- **Windowsパスにバックスラッシュを使用**: `C:\path\to\tests`
- **サブディレクトリを含める**: ツールは自動的に再帰的にスキャン
- **パスが存在することを確認**: ツールは処理前に検証

#### 出力ファイル入力
```
Excelレポートの出力ファイルパスを入力してください:
[C:\Reports\TestSpecification_20260107_143022.xlsx]
```
- **ファイル名と.xlsx拡張子を含むフルパスを指定**
- **デフォルトタイムスタンプ**: ツールはタイムスタンプ付きファイル名を提案
- **ディレクトリが存在することを確認**: 出力ディレクトリは書き込み可能である必要
- **上書き確認**: ファイルが既に存在する場合、ツールが確認

#### 確認ダイアログ
処理前に設定を確認：
```
設定サマリ:

ソースディレクトリ: C:\Projects\MyProject\src\test\java
出力ファイル: C:\Reports\TestSpecification_20260107_143022.xlsx

テスト仕様書の生成を続行しますか？
[はい] [いいえ]
```

### 処理ワークフロー

確認後、ツールは以下のステップを実行：

1. **Javaファイルのスキャン** (10% - 20%)
   - `.java`ファイルを再帰的に検索
   - ファイルサイズでフィルタ（ファイルあたり最大10MB）
   - 発見ファイル数を報告

2. **アノテーションの処理** (20% - 40%)
   - 各Javaファイルを読み取り
   - JavaDocコメントブロックを抽出
   - カスタムアノテーションを解析
   - テストケースレコードを作成

3. **カバレッジレポートのスキャン** (40% - 60%)
   - JaCoCo XMLおよびHTMLレポートを検索
   - 命名パターンによりカバレッジファイルを識別
   - 発見されたカバレッジレポート数を報告

4. **カバレッジデータの処理** (60% - 70%)
   - JaCoCo XMLレポートを解析
   - ブランチ、命令、行カバレッジを抽出
   - C1カバレッジ率を計算

5. **データのマージ** (70% - 80%)
   - ファイルパスでテストケースをカバレッジデータにリンク
   - アノテーションとカバレッジ情報を結合
   - 競合と欠損データを解決

6. **Excelレポートの生成** (80% - 100%)
   - マルチシートワークブックを作成
   - 書式とスタイルを適用
   - 指定された出力ファイルに保存

### 進行状況の監視

処理中は以下で進行状況を監視：
- **Excelステータスバー**: 現在のステップと進行率を表示
- **処理メッセージ**: 詳細なステップ説明
- **時間推定**: ファイル数とサイズに基づく

ステータスメッセージの例：
```
Java Test Specification Generator - Javaテストファイルをスキャン中... (10%)
Java Test Specification Generator - 25個のJavaファイルを発見。アノテーションを処理中... (20%)
Java Test Specification Generator - 78個のテストケースを発見。カバレッジレポートをスキャン中... (40%)
```

## 高度な機能

### 大規模プロジェクトの最適化

多数のファイル（Javaファイル200個以上）を持つプロジェクトの場合：

#### 性能設定
- **ファイルサイズ制限**: 10MB以上のファイルを自動的にスキップ
- **メモリ管理**: メモリ問題を回避するため、ファイルを順次処理
- **進行レポート**: タイムアウトの見た目を防ぐための定期更新
- **エラー回復**: 個別のファイルが失敗しても処理を継続

#### 大規模プロジェクトのベストプラクティス
1. **オフピーク時間中に実行**してシステムの遅延を回避
2. **不必要なアプリケーションを閉じて**メモリを解放
3. **可能な場合はネットワークパスではなくローカルドライブを使用**
4. **非常に大きなプロジェクトはモジュールに分割することを検討**

### カスタムアノテーションサポート

ツールは拡張可能なアノテーション解析をサポート：

#### 新しいアノテーションの追加
1. **JavaAnnotationParser.basを変更**
2. **`ApplyAnnotationsToTestCase`サブルーチンに新しいケースを追加**
3. **必要に応じてDataTypes.basのTestCaseInfo構造を更新**
4. **本番使用前にサンプルファイルでテスト**

#### アノテーション継承
- **クラスレベルのアノテーション**はクラス内のすべてのメソッドに適用
- **メソッドレベルのアノテーション**はクラスレベルの値を上書き
- **欠損アノテーション**は「Not Specified」として表示

### カバレッジレポート統合

#### サポートされるJaCoCoフォーマット
- **XMLレポート**: `jacoco.xml`、`jacoco-report.xml`、`*coverage*.xml`
- **HTMLレポート**: カバレッジディレクトリの`index.html`、`*coverage*.html`

#### カバレッジマッチングロジック
ツールは以下の方法でカバレッジデータをテストファイルにリンク：
1. **ファイルパスマッチング**: Javaファイルパスをカバレッジソースファイルと比較
2. **クラス名解決**: カバレッジレポート内のクラス名をマッチング
3. **パッケージ構造**: パッケージパスをファイル場所に解決

#### 抽出されるカバレッジメトリクス
- **C1カバレッジ**: ブランチ/条件カバレッジ率
- **命令カバレッジ**: C0カバレッジメトリクス
- **行カバレッジ**: 実行可能行カバレッジ
- **メソッドカバレッジ**: 個別メソッド統計

## トラブルシューティング

### 一般的なエラーメッセージ

#### 「ソースディレクトリが存在しません」
```
問題: 指定されたディレクトリパスが無効
解決策:
- ディレクトリパスのスペルと大文字小文字を確認
- 完全な絶対パスを使用 (C:\path\to\directory)
- 該当する場合、ネットワークドライブの接続を確認
- ディレクトリへの読み取り権限があることを確認
```

#### 「出力ファイル保存時に権限が拒否されました」
```
問題: 指定された出力場所に書き込みできない
解決策:
- 出力ディレクトリが存在し、書き込み可能であることを確認
- 同じ名前の既存Excelファイルを閉じる
- 十分なディスク容量があることを確認（少なくとも50MB空き）
- 必要に応じて管理者としてExcelを実行
```

#### 「ディレクトリにJavaファイルが見つかりません」
```
問題: ディレクトリに.javaファイルが含まれていない
解決策:
- ディレクトリにJavaテストファイルが含まれていることを確認
- ファイル拡張子が正確に「.java」であることを確認
- ファイルが隠しファイルやシステムファイルでないことを確認
- まずsample-java-testsディレクトリで試行
```

#### 「Javaアノテーションの解析に失敗しました」
```
問題: Javaファイルのアノテーション形式に問題
解決策:
- JavaDocコメント形式を確認 (/** ... */)
- アノテーションが@記号で始まることを確認
- アノテーション値から特殊文字を削除
- java-annotation-template.javaのテンプレート形式を使用
```

#### 「JaCoCoカバレッジレポートの解析に失敗しました」
```
問題: カバレッジレポート形式が認識されない
解決策:
- JaCoCoがXMLレポートを生成したことを確認（HTMLのみでない）
- ファイル命名がJaCoCo規約に従っていることを確認
- XML構造が有効であることを確認（ブラウザ/エディタで開く）
- 最新のJaCoCoバージョンで新しいカバレッジレポートを生成
```

### 性能問題

#### 処理が遅い（100ファイル未満で10分以上）
```
可能な原因と解決策:
- ネットワークドライブ: プロジェクトを一時的にローカルドライブにコピー
- ウイルス対策スキャン: プロジェクトディレクトリを除外に追加
- メモリ不足: 他のアプリケーションを閉じ、Excelを再起動
- 大きなファイル: 異常に大きなJavaファイル（>1MB）を確認
```

#### メモリエラー
```
メモリ不足エラーの解決策:
- 他のExcelワークブックとアプリケーションを閉じる
- Excelを再起動して再試行
- より小さなサブディレクトリを個別に処理
- 可能であれば仮想メモリを増やす
```

#### 生成中にExcelがクラッシュ
```
回復手順:
- 実行前にVBAコードの変更を保存
- 「警告を表示してすべてのマクロを無効にする」を有効化
- まず小さなサンプルでテスト
- Excelインストールでアップデートをチェック
```

### デバッグ技術

#### VBA イミディエイトウィンドウ
1. **VBAエディタでCtrl+G**を押してイミディエイトウィンドウを開く
2. **VBAコードにデバッグ文を追加**: `Debug.Print "Current file: " & fileName`
3. **実行中の処理をリアルタイムで監視**
4. **`MainController.g_ProcessingErrors`でエラー詳細を確認**

#### エラーログ分析
```vba
' VBA イミディエイトウィンドウで以下を入力:
For i = 1 To MainController.g_ProcessingErrors.Count
    Debug.Print MainController.g_ProcessingErrors(i)
Next i
```

#### ステップバイステップデバッグ
1. **VBAコードの主要な関数にブレークポイントを設定**
2. **F8を押してコードを一行ずつステップ実行**
3. **マウスホバーまたはウォッチウィンドウで変数値をチェック**
4. **対象修正のため正確な失敗ポイントを特定**

## ベストプラクティス

### Javaファイルの構成

#### 推奨ディレクトリ構造
```
src/
├── main/java/                  # 本番コード
└── test/java/                  # テストファイル（このディレクトリをスキャン）
    ├── unit/                   # ユニットテスト
    ├── integration/            # 統合テスト
    └── system/                 # システムテスト
```

#### ファイル命名規約
- **一貫した命名を使用**: `ClassNameTest.java`または`TestClassName.java`
- **関連テストをグループ化**: パッケージ構造はメインコードを反映
- **テストタイプを分離**: ユニット/統合テスト用の異なるディレクトリ

### アノテーションのベストプラクティス

#### 完全な文書化
```java
/**
 * @TestModule UserManagementModule
 * @TestCase UserRegistrationValidation
 * @BaselineVersion 2.1.0
 * @TestOverview 様々な入力組み合わせでユーザー登録フォームを検証
 * @TestPurpose 適切な検証により無効なユーザー登録を防ぐことを確認
 * @TestProcess 有効および無効なデータ組み合わせで登録フォームを送信
 * @TestResults 有効なデータは受け入れ、無効なデータは適切なエラーメッセージで拒否
 * @Creator John Smith
 * @CreatedDate 2026-01-07
 * @Modifier Jane Doe
 * @ModifiedDate 2026-01-07
 * @Priority High
 * @Requirements REQ-USER-001, REQ-USER-002
 */
```

#### 一貫性ガイドライン
1. **全テストファイル間で一貫した用語を使用**
2. **日付形式を厳密に守る**（YYYY-MM-DD）
3. **説明を簡潔に保つ**が情報に富む
4. **テスト変更時に修正情報を更新**
5. **標準化された作成者名を使用**（ニックネームなし）

### カバレッジレポート生成

#### JaCoCo設定
```xml
<!-- Mavenプロジェクトのpom.xml -->
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.7</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

#### レポート生成コマンド
```bash
# Mavenプロジェクト
mvn clean test jacoco:report

# Gradleプロジェクト
./gradlew test jacocoTestReport

# Antプロジェクト
ant test jacoco-report
```

### ワークフロー統合

#### 定期的な文書更新
1. **主要なテスト変更後にツールを実行**して文書を更新
2. **コードレビュープロセスに含める**アノテーション完全性の確認
3. **リリース前にレポートを生成**成果物文書用
4. **過去のレポートをアーカイブ**トレンド分析用

#### チーム調整
- **チームメンバー間でアノテーション形式を標準化**
- **VBAツール設定を共有**一貫性確保のため
- **VBAコードのカスタム修正を文書化**
- **アノテーション標準とツール使用に関するトレーニングを提供**

#### 品質保証
1. **生成されたレポートの精度と完全性をレビュー**
2. **実際のテスト実行と照らしてカバレッジ率を検証**
3. **新しいテストファイルの欠損アノテーションをチェック**
4. **テストと要件間のリンクを確認**

### メンテナンスと更新

#### 定期メンテナンスタスク
- **アノテーション標準変更時にVBAモジュールを更新**
- **新しいJava/JaCoCoバージョンで互換性をテスト**
- **古いカバレッジレポートをレビューとクリーンアップ**
- **新機能追加時に文書を更新**

#### バージョン管理
- **VBAモジュール変更をバージョンコメントで追跡**
- **プロジェクトリポジトリにサンプルファイルを含める**
- **チームwikiで設定変更を文書化**
- **修正前に動作中の設定をバックアップ**

---

*このユーザーガイドは、Java テスト仕様書生成ツールを効果的に使用するための包括的な手順を提供します。追加の技術詳細については、[README.md](../README.md)およびプロジェクト内の他の文書ファイルを参照してください。*