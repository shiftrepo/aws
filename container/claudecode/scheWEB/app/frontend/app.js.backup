/**
 * ãƒãƒ¼ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
 * 7:00-19:00ã‚’30åˆ†å›ºå®šã‚°ãƒªãƒƒãƒ‰ (24ã‚¹ãƒ­ãƒƒãƒˆ) + APIé€£æº
 */

class ScheduleManager {
    constructor() {
        this.currentView = 'grid';
        this.scheduleData = [];
        this.users = [];
        this.gridData = [];

        // 7:00ã‹ã‚‰19:00ã¾ã§30åˆ†é–“éš”ã§24ã‚¹ãƒ­ãƒƒãƒˆ
        this.timeSlots = this.generateTimeSlots();
        this.apiBaseUrl = '/api';

        this.init();
    }

    /**
     * æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ (7:00-19:00, 30åˆ†é–“éš”)
     */
    generateTimeSlots() {
        const slots = [];
        for (let hour = 7; hour < 19; hour++) {
            slots.push({
                index: slots.length,
                start: `${hour.toString().padStart(2, '0')}:00`,
                end: `${hour.toString().padStart(2, '0')}:30`,
                label: `${hour.toString().padStart(2, '0')}:00-${hour.toString().padStart(2, '0')}:30`
            });
            slots.push({
                index: slots.length,
                start: `${hour.toString().padStart(2, '0')}:30`,
                end: `${(hour + 1).toString().padStart(2, '0')}:00`,
                label: `${hour.toString().padStart(2, '0')}:30-${(hour + 1).toString().padStart(2, '0')}:00`
            });
        }
        return slots;
    }

    /**
     * åˆæœŸåŒ–
     */
    async init() {
        this.bindEvents();
        this.setupGrid();
        await this.loadData();
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
     */
    bindEvents() {
        document.getElementById('gridViewBtn').addEventListener('click', () => this.switchView('grid'));
        document.getElementById('listViewBtn').addEventListener('click', () => this.switchView('list'));
        document.getElementById('refreshBtn').addEventListener('click', () => this.loadData());
        document.getElementById('retryBtn').addEventListener('click', () => this.loadData());

        document.getElementById('userFilter').addEventListener('change', () => this.filterList());
        document.getElementById('timeFilter').addEventListener('change', () => this.filterList());
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰æ§‹é€ ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
     */
    setupGrid() {
        // æ™‚é–“ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç•ªå·ä»˜ãï¼‰ã‚’ç”Ÿæˆ
        const gridNumbers = document.querySelector('.grid-numbers');
        gridNumbers.innerHTML = '';

        this.timeSlots.forEach(slot => {
            const timeCell = document.createElement('div');
            timeCell.className = 'time-cell';
            timeCell.innerHTML = `
                <div class="grid-number">${slot.index}</div>
                <div class="time-label">${slot.label}</div>
            `;
            gridNumbers.appendChild(timeCell);
        });
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     */
    async loadData() {
        try {
            this.showLoading(true);
            this.hideError();

            console.log('ğŸ”¥ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');

            // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ï¼‰
            const token = localStorage.getItem('authToken');
            if (!token) {
                throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
            }

            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            // ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const [usersResponse, gridResponse] = await Promise.all([
                fetch(`${this.apiBaseUrl}/availability/all`, { headers }),
                fetch(`${this.apiBaseUrl}/grid-schedule`, { headers })
            ]);

            if (!usersResponse.ok) {
                if (usersResponse.status === 401) {
                    throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
                throw new Error(`Users API failed: ${usersResponse.status}`);
            }
            if (!gridResponse.ok) {
                if (gridResponse.status === 401) {
                    throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
                throw new Error(`Grid API failed: ${gridResponse.status}`);
            }

            const usersData = await usersResponse.json();
            const gridData = await gridResponse.json();

            console.log('âœ… Users data loaded:', usersData);
            console.log('âœ… Grid data loaded:', gridData);

            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ­£è¦åŒ–
            if (Array.isArray(usersData)) {
                this.users = usersData;
            } else {
                this.users = usersData.users || [];
            }

            if (gridData.grid_schedule) {
                // grid-schedule APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œ
                this.gridData = this.processGridSchedule(gridData.grid_schedule);
            } else {
                this.gridData = gridData.grid || [];
            }

            this.scheduleData = this.processScheduleData();

            console.log('ğŸ“Š å‡¦ç†æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', this.users.length);
            console.log('ğŸ“Š å‡¦ç†æ¸ˆã¿ã‚°ãƒªãƒƒãƒ‰æ•°:', this.gridData.length);

            this.renderGrid();
            this.renderList();
            this.populateUserFilter();

        } catch (error) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            this.showError(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        } finally {
            this.showLoading(false);
        }
    }

    /**
     * grid-schedule APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
     */
    processGridSchedule(gridSchedule) {
        const processedGrid = [];

        // å„æ›œæ—¥ã®å„æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’å‡¦ç†
        Object.entries(gridSchedule).forEach(([day, daySlots]) => {
            if (Array.isArray(daySlots)) {
                daySlots.forEach(slot => {
                    processedGrid.push({
                        day: day,
                        grid_index: slot.grid_index,
                        start: slot.start,
                        end: slot.end,
                        participant_count: slot.participant_count,
                        available_users: slot.available_users || [],
                        unavailable_users: slot.unavailable_users || [],
                        availability_percentage: slot.availability_percentage || 0
                    });
                });
            }
        });

        return processedGrid;
    }

    /**
     * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
     */
    processScheduleData() {
        const processed = [];

        // gridDataã‹ã‚‰è©³ç´°ãƒªã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        this.gridData.forEach(slot => {
            if (slot.available_users && slot.available_users.length > 0) {
                slot.available_users.forEach(username => {
                    processed.push({
                        username: username,
                        start_time: slot.start,
                        end_time: slot.end,
                        grid_index: slot.grid_index,
                        available: true
                    });
                });
            }
        });

        return processed;
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    renderGrid() {
        const userList = document.querySelector('.user-list');
        const gridCells = document.querySelector('.grid-cells');

        if (!userList || !gridCells) {
            console.error('âŒ ã‚°ãƒªãƒƒãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        userList.innerHTML = '';
        gridCells.innerHTML = '';

        if (this.users.length === 0) {
            userList.innerHTML = '<div class="no-data">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>';
            return;
        }

        console.log('ğŸ¯ ã‚°ãƒªãƒƒãƒ‰æç”»é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', this.users.length);

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è¡Œã‚’ä½œæˆ
        this.users.forEach((user, userIndex) => {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            const userRow = document.createElement('div');
            userRow.className = 'user-row';
            userRow.textContent = user.username || `User ${userIndex + 1}`;
            userList.appendChild(userRow);

            // ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«è¡Œ
            const cellRow = document.createElement('div');
            cellRow.className = 'cell-row';

            // å„æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®ã‚»ãƒ«
            this.timeSlots.forEach((slot, index) => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.user = user.username;
                cell.dataset.gridIndex = index;

                // ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæœˆæ›œæ—¥ã‚’ä½¿ç”¨ï¼‰ã‚’æ¤œç´¢
                const gridSlot = this.gridData.find(g =>
                    g.grid_index === index && (g.day === 'monday' || !g.day)
                );

                const isAvailable = gridSlot && gridSlot.available_users &&
                                  gridSlot.available_users.includes(user.username);

                if (isAvailable) {
                    cell.classList.add('available');

                    // å‚åŠ è€…æ•°ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
                    const participantCount = gridSlot.participant_count || 0;
                    if (participantCount === 1) {
                        cell.classList.add('single-user');
                    } else if (participantCount === this.users.length) {
                        cell.classList.add('full-meeting');
                    } else {
                        cell.classList.add('partial-meeting');
                    }

                    cell.title = `${user.username} - ${slot.label} åˆ©ç”¨å¯èƒ½ (${participantCount}äººå‚åŠ )`;

                    // ã‚°ãƒªãƒƒãƒ‰ç•ªå·ã‚’è¡¨ç¤º
                    const gridNumber = document.createElement('span');
                    gridNumber.className = 'grid-number-display';
                    gridNumber.textContent = index;
                    cell.appendChild(gridNumber);

                } else {
                    cell.classList.add('unavailable');
                    cell.title = `${user.username} - ${slot.label} åˆ©ç”¨ä¸å¯`;
                }

                cellRow.appendChild(cell);
            });

            gridCells.appendChild(cellRow);
        });

        console.log('âœ… ã‚°ãƒªãƒƒãƒ‰æç”»å®Œäº†');

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        this.logGridDebugInfo();
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
     */
    logGridDebugInfo() {
        console.log('ğŸ” ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
        console.log('Time slots:', this.timeSlots.length);
        console.log('Grid data:', this.gridData.length);

        // user2 (ken) ã® 08:30 (ã‚°ãƒªãƒƒãƒ‰#3) ã‚’ç‰¹åˆ¥ã«ãƒã‚§ãƒƒã‚¯
        const kenGrid3 = this.gridData.find(g =>
            g.grid_index === 3 && g.day === 'monday'
        );

        if (kenGrid3) {
            console.log('ğŸ¯ ken (user2) ã®ã‚°ãƒªãƒƒãƒ‰#3 (08:30-09:00):', kenGrid3);
        } else {
            console.log('âŒ ken (user2) ã®ã‚°ãƒªãƒƒãƒ‰#3ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        // æœ€åˆã®5ã¤ã®ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º
        console.log('ğŸ“Š æœ€åˆã®5ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒ­ãƒƒãƒˆ:');
        this.gridData.slice(0, 5).forEach(slot => {
            console.log(`  ã‚°ãƒªãƒƒãƒ‰#${slot.grid_index}: ${slot.start}-${slot.end} (${slot.available_users?.join(', ')})`);
        });
    }

    /**
     * ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    renderList() {
        const scheduleList = document.getElementById('scheduleList');
        scheduleList.innerHTML = '';

        if (this.scheduleData.length === 0) {
            scheduleList.innerHTML = '<div class="no-data">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        // ã‚°ãƒªãƒƒãƒ‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †ã§ã‚½ãƒ¼ãƒˆ
        const sortedData = [...this.scheduleData].sort((a, b) => a.grid_index - b.grid_index);

        sortedData.forEach(item => {
            const listItem = document.createElement('div');
            listItem.className = `schedule-item ${item.available ? 'available' : 'unavailable'}`;

            listItem.innerHTML = `
                <div class="item-header">
                    <span class="grid-index">ã‚°ãƒªãƒƒãƒ‰#${item.grid_index}</span>
                    <span class="username">${item.username}</span>
                    <span class="status ${item.available ? 'available' : 'unavailable'}">
                        ${item.available ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯'}
                    </span>
                </div>
                <div class="time-range">
                    ${item.start_time} - ${item.end_time}
                </div>
            `;

            scheduleList.appendChild(listItem);
        });
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
     */
    populateUserFilter() {
        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="">å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>';

        this.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = user.username;
            userFilter.appendChild(option);
        });
    }

    /**
     * ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     */
    filterList() {
        const userFilter = document.getElementById('userFilter').value;
        const timeFilter = document.getElementById('timeFilter').value;
        const items = document.querySelectorAll('.schedule-item');

        items.forEach(item => {
            const username = item.querySelector('.username').textContent;
            const timeRange = item.querySelector('.time-range').textContent;

            let showItem = true;

            if (userFilter && username !== userFilter) {
                showItem = false;
            }

            if (timeFilter && !timeRange.includes(timeFilter)) {
                showItem = false;
            }

            item.style.display = showItem ? 'block' : 'none';
        });
    }

    /**
     * è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
     */
    switchView(viewType) {
        this.currentView = viewType;

        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`${viewType}View`).classList.add('active');
        document.getElementById(`${viewType}ViewBtn`).classList.add('active');
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
     */
    showLoading(show) {
        const loading = document.getElementById('loading');
        loading.style.display = show ? 'flex' : 'none';
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
     */
    showError(message) {
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        error.classList.remove('hidden');
    }

    hideError() {
        const error = document.getElementById('error');
        error.classList.add('hidden');
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
document.addEventListener('DOMContentLoaded', () => {
    window.scheduleManager = new ScheduleManager();
});