---
# ========================================
# Kubernetes Dashboard ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« - Ansible
# ========================================
# K3sç”¨ã®Kubernetes Dashboard Web UIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ
# å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ãƒãƒ¼ãƒˆè»¢é€ã‚’è¨­å®š
# ========================================

- name: Install Kubernetes Dashboard for K3s
  hosts: localhost
  gather_facts: yes
  become: yes
  become_method: sudo

  vars:
    kubectl_path: "/usr/local/bin/kubectl"
    dashboard_version: "v2.7.0"
    dashboard_namespace: "kubernetes-dashboard"
    dashboard_external_port: 5001
    dashboard_nodeport: 30443

  tasks:
    # ========================================
    # Step 1: Kubernetes Dashboard ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # ========================================

    - name: Install Kubernetes Dashboard
      shell: |
        {{ kubectl_path }} apply -f https://raw.githubusercontent.com/kubernetes/dashboard/{{ dashboard_version }}/aio/deploy/recommended.yaml
      register: dashboard_install
      changed_when: "'created' in dashboard_install.stdout or 'configured' in dashboard_install.stdout"
      failed_when: false

    - name: Wait for Dashboard pods to be ready
      shell: |
        {{ kubectl_path }} wait --for=condition=ready pod \
          -l k8s-app=kubernetes-dashboard \
          -n {{ dashboard_namespace }} \
          --timeout=60s
      register: wait_result
      retries: 3
      delay: 10
      until: wait_result.rc == 0
      failed_when: false

    # ========================================
    # Step 2: ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    # ========================================

    - name: Create Dashboard admin ServiceAccount
      shell: |
        cat <<EOF | {{ kubectl_path }} apply -f -
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: {{ dashboard_namespace }}
        EOF
      register: sa_result
      changed_when: "'created' in sa_result.stdout or 'configured' in sa_result.stdout"

    - name: Create Dashboard admin ClusterRoleBinding
      shell: |
        cat <<EOF | {{ kubectl_path }} apply -f -
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: {{ dashboard_namespace }}
        EOF
      register: crb_result
      changed_when: "'created' in crb_result.stdout or 'configured' in crb_result.stdout"

    # ========================================
    # Step 3: ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆ
    # ========================================

    - name: Create Dashboard admin token Secret
      shell: |
        cat <<EOF | {{ kubectl_path }} apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: admin-user-token
          namespace: {{ dashboard_namespace }}
          annotations:
            kubernetes.io/service-account.name: admin-user
        type: kubernetes.io/service-account-token
        EOF
      register: token_secret
      changed_when: "'created' in token_secret.stdout or 'configured' in token_secret.stdout"

    - name: Wait for token to be generated
      pause:
        seconds: 5

    - name: Get Dashboard admin token
      shell: |
        {{ kubectl_path }} get secret admin-user-token \
          -n {{ dashboard_namespace }} \
          -o jsonpath='{.data.token}' | base64 -d
      register: dashboard_token
      changed_when: false

    - name: Save token to file
      copy:
        content: "{{ dashboard_token.stdout }}"
        dest: /tmp/kubernetes-dashboard-token.txt
        mode: '0600'

    # ========================================
    # Step 4: NodePort Serviceä½œæˆ
    # ========================================

    - name: Create NodePort Service for Dashboard
      shell: |
        cat <<EOF | {{ kubectl_path }} apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: kubernetes-dashboard-nodeport
          namespace: {{ dashboard_namespace }}
        spec:
          type: NodePort
          selector:
            k8s-app: kubernetes-dashboard
          ports:
          - protocol: TCP
            port: 443
            targetPort: 8443
            nodePort: {{ dashboard_nodeport }}
        EOF
      register: nodeport_result
      changed_when: "'created' in nodeport_result.stdout or 'configured' in nodeport_result.stdout"

    # ========================================
    # Step 5: å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒãƒ¼ãƒˆè»¢é€
    # ========================================

    - name: Check if socat is installed
      command: which socat
      register: socat_check
      failed_when: false
      changed_when: false

    - name: Install socat if not present
      package:
        name: socat
        state: present
      when: socat_check.rc != 0

    - name: Get node IP
      shell: hostname -I | awk '{print $1}'
      register: node_ip
      changed_when: false

    - name: Stop existing dashboard port forward service
      systemd:
        name: k3s-dashboard-forward
        state: stopped
      failed_when: false

    - name: Create systemd service for Dashboard port forwarding
      copy:
        dest: /etc/systemd/system/k3s-dashboard-forward.service
        content: |
          [Unit]
          Description=K3s Dashboard Port Forward ({{ dashboard_external_port }} -> {{ dashboard_nodeport }})
          After=network.target

          [Service]
          Type=simple
          User=root
          ExecStart=/usr/bin/socat TCP-LISTEN:{{ dashboard_external_port }},bind=0.0.0.0,fork,reuseaddr TCP:{{ node_ip.stdout }}:{{ dashboard_nodeport }}
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Dashboard port forward service
      systemd:
        name: k3s-dashboard-forward
        enabled: yes
        state: started

    # ========================================
    # Step 6: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š
    # ========================================

    - name: Check if firewalld is running
      systemd:
        name: firewalld
      register: firewalld_status
      failed_when: false

    - name: Open Dashboard port in firewall
      firewalld:
        port: "{{ dashboard_external_port }}/tcp"
        permanent: yes
        state: enabled
        immediate: yes
      when: firewalld_status.status.ActiveState == "active"
      failed_when: false

    # ========================================
    # Step 7: çŠ¶æ…‹ç¢ºèª
    # ========================================

    - name: Get Dashboard pods status
      shell: |
        {{ kubectl_path }} get pods -n {{ dashboard_namespace }}
      register: dashboard_pods
      changed_when: false

    - name: Get Dashboard services
      shell: |
        {{ kubectl_path }} get svc -n {{ dashboard_namespace }}
      register: dashboard_svcs
      changed_when: false

    - name: Get public IP
      uri:
        url: http://169.254.169.254/latest/meta-data/public-ipv4
        return_content: yes
        timeout: 5
      register: public_ip
      failed_when: false
      changed_when: false

    # ========================================
    # Step 8: ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    # ========================================

    - name: Create installation report
      copy:
        dest: "/root/aws.git/container/claudecode/ArgoCD/K3S-DASHBOARD-INSTALLATION.md"
        content: |
          # Kubernetes Dashboard ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

          **æ—¥æ™‚**: {{ ansible_date_time.iso8601 }}
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†

          ---

          ## ğŸ“Š ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©³ç´°

          ### Dashboardæƒ…å ±
          - **Version**: {{ dashboard_version }}
          - **Namespace**: {{ dashboard_namespace }}
          - **NodePort**: {{ dashboard_nodeport }}
          - **External Port**: {{ dashboard_external_port }}

          ### ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±

          #### å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆHTTPSï¼‰
          ```
          {% if public_ip.content is defined %}
          URL: https://{{ public_ip.content }}:{{ dashboard_external_port }}
          URL: https://ec2-{{ public_ip.content | replace('.', '-') }}.compute-1.amazonaws.com:{{ dashboard_external_port }}
          {% else %}
          URL: https://localhost:{{ dashboard_external_port }}
          {% endif %}
          ```

          #### ãƒ­ã‚°ã‚¤ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³
          ```
          {{ dashboard_token.stdout }}
          ```

          ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: `/tmp/kubernetes-dashboard-token.txt`

          ---

          ## ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æ‰‹é †

          1. **ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹**
          ```
          {% if public_ip.content is defined %}
          https://{{ public_ip.content }}:{{ dashboard_external_port }}
          {% else %}
          https://localhost:{{ dashboard_external_port }}
          {% endif %}
          ```

          2. **è¨¼æ˜æ›¸è­¦å‘Šã‚’ã‚¹ã‚­ãƒƒãƒ—**
          - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ãŸã‚è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          - ã€Œè©³ç´°è¨­å®šã€â†’ã€Œå®‰å…¨ã§ãªã„ã‚µã‚¤ãƒˆã«é€²ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

          3. **ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ­ã‚°ã‚¤ãƒ³**
          - ã€ŒTokenã€ã‚’é¸æŠ
          - ä¸Šè¨˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ
          - ã€ŒSign inã€ã‚’ã‚¯ãƒªãƒƒã‚¯

          ---

          ## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹

          ### Pods
          ```
          {{ dashboard_pods.stdout }}
          ```

          ### Services
          ```
          {{ dashboard_svcs.stdout }}
          ```

          ---

          ## ğŸ”„ å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          ```bash
          cd /root/aws.git/container/claudecode/ArgoCD
          ansible-playbook -i ansible/inventory/hosts.yml \
            ansible/playbooks/install_k3s_dashboard.yml
          ```

          ---

          ## ğŸ—‘ï¸ ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          ```bash
          # Dashboardãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
          kubectl delete namespace {{ dashboard_namespace }}

          # ãƒãƒ¼ãƒˆè»¢é€ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
          systemctl stop k3s-dashboard-forward
          systemctl disable k3s-dashboard-forward
          rm -f /etc/systemd/system/k3s-dashboard-forward.service
          systemctl daemon-reload
          ```

          ---

          ## ğŸ“ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

          ### PodãŒèµ·å‹•ã—ãªã„
          ```bash
          kubectl get pods -n {{ dashboard_namespace }}
          kubectl describe pod <pod-name> -n {{ dashboard_namespace }}
          kubectl logs <pod-name> -n {{ dashboard_namespace }}
          ```

          ### ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹
          ```bash
          # æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
          kubectl get secret admin-user-token \
            -n {{ dashboard_namespace }} \
            -o jsonpath='{.data.token}' | base64 -d
          ```

          ### ãƒãƒ¼ãƒˆè»¢é€ãŒå‹•ä½œã—ãªã„
          ```bash
          # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
          systemctl status k3s-dashboard-forward

          # å†èµ·å‹•
          systemctl restart k3s-dashboard-forward

          # ãƒ­ã‚°ç¢ºèª
          journalctl -u k3s-dashboard-forward -f
          ```

          ---

          **Kubernetes Dashboard ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸï¼**
        mode: '0644'

    - name: Display installation summary
      debug:
        msg:
          - "========================================="
          - "Kubernetes Dashboard ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
          - "========================================="
          - ""
          - "ã‚¢ã‚¯ã‚»ã‚¹URL:"
          - "{% if public_ip.content is defined %}https://{{ public_ip.content }}:{{ dashboard_external_port }}{% else %}https://localhost:{{ dashboard_external_port }}{% endif %}"
          - ""
          - "ãƒ­ã‚°ã‚¤ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³:"
          - "{{ dashboard_token.stdout }}"
          - ""
          - "è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: /root/aws.git/container/claudecode/ArgoCD/K3S-DASHBOARD-INSTALLATION.md"
          - "========================================="

  tags:
    - k3s
    - dashboard
    - install
