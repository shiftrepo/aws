---
# ========================================
# ÂÆåÂÖ®Ëá™ÂãïÂõûÂ∏∞„ÉÜ„Çπ„Éà - 0„Åã„Çâ„ÅÆÁí∞Â¢ÉÊßãÁØâ„Å®„Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ„ÉÜ„Çπ„Éà
# ========================================
# K3sÂâäÈô§ ‚Üí ‰∏°„Éê„Éº„Ç∏„Éß„É≥„Éì„É´„Éâ ‚Üí K3sÊßãÁØâ ‚Üí „Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„Éó/„ÉÄ„Ç¶„É≥„ÉÜ„Çπ„Éà
#
# ÂÆüË°åÊñπÊ≥ï:
#   cd /root/aws.git/container/claudecode/ArgoCD/ansible
#   ansible-playbook playbooks/deploy_regression_test_complete.yml
# ========================================

- name: Complete Regression Test from Scratch
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    # ansible/config/environment.yml „ÅÆ directories.base_dir „Åã„ÇâÂèñÂæó
    project_root: "{{ environment_config.directories.base_dir }}"
    backend_dir: "{{ project_root }}/app/backend"
    frontend_dir: "{{ project_root }}/app/frontend"
    # externalIPs„Å´‰ΩøÁî®„Åô„ÇãIP: environment.yml„ÅßÊåáÂÆö„ÄÅÁ©∫„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÊ§úÂá∫
    effective_external_ip: "{{ environment_config.network.external_ip | default('') | trim }}"
    private_ip: "{{ ansible_default_ipv4.address }}"
    v1_0_0_tag: "argocd-regression-v1.0.0"
    v1_1_0_branch: "main"

  pre_tasks:
    - name: Load environment configuration
      include_vars:
        file: "{{ playbook_dir }}/../config/environment.yml"
        name: environment_config

      tags: [always]
    - name: Detect container runtime (docker first, then {{ container_cmd }})
      block:
        - name: Check docker availability
          command: docker info
          register: docker_check
          failed_when: false
          changed_when: false
          become: no

        - name: Set container runtime to docker
          set_fact:
            container_cmd: "docker"
          when: docker_check.rc == 0

        - name: Set container runtime to {{ container_cmd }} (fallback)
          set_fact:
            container_cmd: "{{ container_cmd }}"
          when: docker_check.rc != 0

        - name: Display container runtime
          debug:
            msg: "Using container runtime: {{ container_cmd }}"
      tags: [always]

  tasks:
    # ========================================
    # Phase 0: Áí∞Â¢ÉÊÉÖÂ†±Ë°®Á§∫
    # ========================================
    - name: Display regression test information
      debug:
        msg:
          - "=========================================="
          - "Complete Regression Test"
          - "=========================================="
          - "v1.0.0 Tag: {{ v1_0_0_tag }}"
          - "v1.1.0 Branch: {{ v1_1_0_branch }}"
          - "Private IP: {{ private_ip }}"
          - "=========================================="

    # ========================================
    # Phase 1: Êó¢Â≠òÁí∞Â¢É„ÅÆÂÆåÂÖ®ÂâäÈô§
    # ========================================
    - name: "PHASE 1: Clean Environment"
      block:
        - name: Check if K3s uninstall script exists
          stat:
            path: /usr/local/bin/k3s-uninstall.sh
          register: k3s_uninstall

        - name: Uninstall K3s
          command: /usr/local/bin/k3s-uninstall.sh
          when: k3s_uninstall.stat.exists
          ignore_errors: yes

        - name: Clean container images and volumes
          shell: |
            {{ container_cmd }} ps -q 2>/dev/null | xargs -r {{ container_cmd }} stop 2>/dev/null || true
            {{ container_cmd }} ps -aq 2>/dev/null | xargs -r {{ container_cmd }} rm -f 2>/dev/null || true
            {{ container_cmd }} system prune -af --volumes 2>/dev/null || true
          ignore_errors: yes

        - name: Remove version history
          file:
            path: "{{ environment_config.directories.version_history_file }}"
            state: absent

        - name: Reset git working tree to clean state
          command: git checkout -- .
          args:
            chdir: "{{ project_root }}"
          ignore_errors: yes

        - name: Display cleanup status
          debug:
            msg: "‚úÖ Environment cleaned"

      tags:
        - cleanup

    # ========================================
    # Phase 2: v1.0.0 „Éì„É´„Éâ
    # ========================================
    - name: "PHASE 2: Build v1.0.0"
      block:
        - name: Checkout v1.0.0 tag
          command: git checkout {{ v1_0_0_tag }}
          args:
            chdir: "{{ project_root }}"
          register: checkout_v1_0_0

        - name: Build v1.0.0 backend
          shell: |
            source /etc/profile.d/maven.sh
            cd {{ backend_dir }}
            mvn clean package -Dmaven.test.skip=true
          args:
            executable: /bin/bash
          become: no

        - name: Install v1.0.0 frontend dependencies
          command: npm install
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Build v1.0.0 frontend
          command: npm run build
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Pull base images for v1.0.0
          shell: |
            {{ container_cmd }} pull docker.io/eclipse-temurin:21-jre-alpine
            {{ container_cmd }} pull docker.io/nginx:alpine
          become: no

        - name: Build v1.0.0 backend image
          command: "{{ container_cmd }} build -t localhost/orgmgmt-backend:1.0.0 -f Dockerfile ."
          args:
            chdir: "{{ backend_dir }}"
          become: no

        - name: Build v1.0.0 frontend image
          command: "{{ container_cmd }} build -t localhost/orgmgmt-frontend:1.0.0 -f Dockerfile ."
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Display v1.0.0 build status
          debug:
            msg: "‚úÖ v1.0.0 images built successfully"

      tags:
        - build-v1.0.0

    # ========================================
    # Phase 3: v1.1.0 „Éì„É´„Éâ
    # ========================================
    - name: "PHASE 3: Build v1.1.0"
      block:
        - name: Checkout main branch
          command: git checkout {{ v1_1_0_branch }}
          args:
            chdir: "{{ project_root }}"

        - name: Build v1.1.0 backend
          shell: |
            source /etc/profile.d/maven.sh
            cd {{ backend_dir }}
            mvn clean package -Dmaven.test.skip=true
          args:
            executable: /bin/bash
          become: no

        - name: Install v1.1.0 frontend dependencies
          command: npm install
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Build v1.1.0 frontend
          command: npm run build
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Build v1.1.0 backend image
          command: "{{ container_cmd }} build -t localhost/orgmgmt-backend:1.1.0 -f Dockerfile ."
          args:
            chdir: "{{ backend_dir }}"
          become: no

        - name: Build v1.1.0 frontend image
          command: "{{ container_cmd }} build -t localhost/orgmgmt-frontend:1.1.0 -f Dockerfile ."
          args:
            chdir: "{{ frontend_dir }}"
          become: no

        - name: Display v1.1.0 build status
          debug:
            msg: "‚úÖ v1.1.0 images built successfully"

      tags:
        - build-v1.1.0

    # ========================================
    # Phase 3.5: Áí∞Â¢É‰æùÂ≠ò„Éû„Éã„Éï„Çß„Çπ„Éà„ÅÆÊ∫ñÂÇô
    # ansible/config/environment.yml „ÅÆË®≠ÂÆö„Çí k8s „Éû„Éã„Éï„Çß„Çπ„Éà„Å´ÂèçÊò†
    # ========================================
    - name: "PHASE 3.5: Prepare Environment-Specific Manifests"
      block:
        - name: Resolve effective external IP
          set_fact:
            resolved_external_ip: "{{ effective_external_ip if effective_external_ip != '' else ansible_default_ipv4.address }}"

        - name: Display resolved IP
          debug:
            msg: "Using externalIP: {{ resolved_external_ip }} (source: {{ 'environment.yml' if effective_external_ip != '' else 'auto-detected' }})"

        - name: Patch externalIPs in backend-service.yaml
          lineinfile:
            path: "{{ project_root }}/k8s-manifests/base/backend-service.yaml"
            regexp: '^\s*- \d+\.\d+\.\d+\.\d+\s*$'
            line: "  - {{ resolved_external_ip }}"

        - name: Patch externalIPs in frontend-service.yaml
          lineinfile:
            path: "{{ project_root }}/k8s-manifests/base/frontend-service.yaml"
            regexp: '^\s*- \d+\.\d+\.\d+\.\d+\s*$'
            line: "  - {{ resolved_external_ip }}"

        - name: Generate argocd-application.yaml from template
          template:
            src: "{{ project_root }}/ansible/templates/argocd-application.yaml.j2"
            dest: "{{ project_root }}/argocd-application.yaml"
            mode: '0644'

        - name: Display manifest preparation status
          debug:
            msg:
              - "‚úÖ Manifests prepared"
              - "  externalIPs: {{ resolved_external_ip }}"
              - "  repoURL: {{ environment_config.git.repository_url }}"
              - "  branch: {{ environment_config.git.branch }}"
              - "  manifests_path: {{ environment_config.git.manifests_path }}/v{{ environment_config.argocd.application.initial_version }}"

      tags:
        - prepare-manifests

    # ========================================
    # Phase 4: K3s + ArgoCD „Ç§„É≥„Çπ„Éà„Éº„É´
    # ========================================
    - name: "PHASE 4: Install K3s and ArgoCD"
      block:
        - name: Install K3s and ArgoCD
          command: /usr/local/bin/ansible-playbook {{ project_root }}/ansible/playbooks/install_k3s_and_argocd.yml
          args:
            chdir: "{{ project_root }}/ansible"

        - name: Wait for K3s to be fully ready
          shell: /usr/local/bin/k3s kubectl get nodes
          register: k3s_nodes
          retries: 30
          delay: 2
          until: k3s_nodes.rc == 0

        - name: Display K3s installation status
          debug:
            msg: "‚úÖ K3s and ArgoCD installed"

      tags:
        - install-k3s

    # ========================================
    # Phase 5: ‰∏°„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Ç§„É°„Éº„Ç∏„ÇíK3s„Å´„Ç§„É≥„Éù„Éº„Éà
    # ========================================
    - name: "PHASE 5: Import Images to K3s"
      block:
        - name: Remove old export files
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/backend-1.0.0.tar
            - /tmp/frontend-1.0.0.tar
            - /tmp/backend-1.1.0.tar
            - /tmp/frontend-1.1.0.tar

        - name: Export v1.0.0 backend image
          command: "{{ container_cmd }} save localhost/orgmgmt-backend:1.0.0 -o /tmp/backend-1.0.0.tar"
          become: no

        - name: Export v1.0.0 frontend image
          command: "{{ container_cmd }} save localhost/orgmgmt-frontend:1.0.0 -o /tmp/frontend-1.0.0.tar"
          become: no

        - name: Export v1.1.0 backend image
          command: "{{ container_cmd }} save localhost/orgmgmt-backend:1.1.0 -o /tmp/backend-1.1.0.tar"
          become: no

        - name: Export v1.1.0 frontend image
          command: "{{ container_cmd }} save localhost/orgmgmt-frontend:1.1.0 -o /tmp/frontend-1.1.0.tar"
          become: no

        - name: Import v1.0.0 images to K3s
          shell: |
            /usr/local/bin/k3s ctr images import /tmp/backend-1.0.0.tar
            /usr/local/bin/k3s ctr images import /tmp/frontend-1.0.0.tar

        - name: Import v1.1.0 images to K3s
          shell: |
            /usr/local/bin/k3s ctr images import /tmp/backend-1.1.0.tar
            /usr/local/bin/k3s ctr images import /tmp/frontend-1.1.0.tar

        - name: Verify images in K3s
          command: /usr/local/bin/k3s crictl images
          register: k3s_images

        - name: Display imported images
          debug:
            msg: "‚úÖ Both v1.0.0 and v1.1.0 images imported to K3s"

      tags:
        - import-images

    # ========================================
    # Phase 6: v1.0.0 ÂàùÊúü„Éá„Éó„É≠„Ç§
    # ========================================
    - name: "PHASE 6: Deploy v1.0.0"
      block:
        - name: Apply v1.0.0 manifests
          command: /usr/local/bin/k3s kubectl apply -k {{ project_root }}/k8s-manifests/overlays/v1.0.0/

        - name: Wait for pods to be ready
          shell: |
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod -l app=postgres --timeout=120s
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
          register: pods_ready
          retries: 3
          delay: 10
          until: pods_ready.rc == 0

        - name: Wait for application pods
          shell: |
            sleep 30
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod -l app=orgmgmt-backend --timeout=120s || true
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod -l app=orgmgmt-frontend --timeout=120s || true

        - name: Apply ArgoCD Application
          command: /usr/local/bin/k3s kubectl apply -f {{ project_root }}/argocd-application.yaml

        - name: Wait for ArgoCD to sync
          shell: |
            for i in {1..60}; do
              status=$(/usr/local/bin/k3s kubectl get application orgmgmt-app -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
              if [ "$status" == "Synced" ]; then
                exit 0
              fi
              sleep 5
            done
            exit 1
          register: argocd_sync
          failed_when: false

        - name: Display v1.0.0 deployment status
          debug:
            msg: "‚úÖ v1.0.0 deployed"

      tags:
        - deploy-v1.0.0

    # ========================================
    # Phase 7: „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÉÜ„Çπ„Éà (v1.0.0 ‚Üí v1.1.0)
    # ========================================
    - name: "PHASE 7: Upgrade to v1.1.0"
      block:
        - name: Run upgrade playbook
          command: /usr/local/bin/ansible-playbook {{ project_root }}/ansible/playbooks/deploy_app_version_gitops.yml -e "app_version={{ environment_config.application.version }}"
          args:
            chdir: "{{ project_root }}/ansible"
          register: upgrade_result

        - name: Display upgrade result
          debug:
            msg: "‚úÖ Upgraded to v{{ environment_config.application.version }}"

      tags:
        - upgrade-test

    # ========================================
    # Phase 8: „É≠„Éº„É´„Éê„ÉÉ„ÇØ„ÉÜ„Çπ„Éà (v1.1.0 ‚Üí v1.0.0)
    # ========================================
    - name: "PHASE 8: Rollback to v1.0.0"
      block:
        - name: Run rollback playbook
          command: /usr/local/bin/ansible-playbook {{ project_root }}/ansible/playbooks/rollback_app_version_gitops.yml -e "target_version={{ environment_config.argocd.application.initial_version }}"
          args:
            chdir: "{{ project_root }}/ansible"
          register: rollback_result

        - name: Display rollback result
          debug:
            msg: "‚úÖ Rolled back to v{{ environment_config.argocd.application.initial_version }}"

      tags:
        - rollback-test

    # ========================================
    # Phase 9: ÂÜç„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÉÜ„Çπ„Éà (v1.0.0 ‚Üí v1.1.0)
    # ========================================
    - name: "PHASE 9: Re-upgrade to v1.1.0"
      block:
        - name: Run re-upgrade playbook
          command: /usr/local/bin/ansible-playbook {{ project_root }}/ansible/playbooks/deploy_app_version_gitops.yml -e "app_version={{ environment_config.application.version }}"
          args:
            chdir: "{{ project_root }}/ansible"
          register: reupgrade_result

        - name: Display re-upgrade result
          debug:
            msg: "‚úÖ Re-upgraded to v{{ environment_config.application.version }}"

      tags:
        - reupgrade-test

    # ========================================
    # Phase 10: ÊúÄÁµÇÁ¢∫Ë™ç
    # ========================================
    - name: "PHASE 10: Final Verification"
      block:
        - name: Get final application status
          command: /usr/local/bin/k3s kubectl get application orgmgmt-app -n argocd -o jsonpath='{.status.sync.status}/{.status.health.status}'
          register: final_status

        - name: Get deployments
          command: /usr/local/bin/k3s kubectl get deployments -o wide
          register: final_deployments

        - name: Get pods
          command: /usr/local/bin/k3s kubectl get pods
          register: final_pods

        - name: Get version history
          command: cat "{{ environment_config.directories.version_history_file }}"
          register: version_history
          failed_when: false

        - name: Display regression test summary
          debug:
            msg:
              - "=========================================="
              - "üéâ REGRESSION TEST COMPLETE!"
              - "=========================================="
              - ""
              - "ArgoCD Status: {{ final_status.stdout }}"
              - ""
              - "Version History:"
              - "{{ version_history.stdout_lines }}"
              - ""
              - "Final Deployments:"
              - "{{ final_deployments.stdout_lines }}"
              - ""
              - "All Tests Passed:"
              - "  ‚úÖ v1.0.0 and v1.1.0 images built"
              - "  ‚úÖ K3s and ArgoCD installed"
              - "  ‚úÖ Initial v1.0.0 deployment"
              - "  ‚úÖ Upgrade v1.0.0 ‚Üí v1.1.0"
              - "  ‚úÖ Rollback v1.1.0 ‚Üí v1.0.0"
              - "  ‚úÖ Re-upgrade v1.0.0 ‚Üí v1.1.0"
              - ""
              - "=========================================="

      tags:
        - verification
