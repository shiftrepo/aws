---
# ========================================
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ—ãƒ­ã‚¤
# ========================================
# æ—¢å­˜ã®K3s/ArgoCDç’°å¢ƒã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®
# æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
#
# å‰ææ¡ä»¶:
#   - K3sã¨ArgoCDãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
#   - PostgreSQLã¨RedisãŒç¨¼åƒä¸­
#
# å®Ÿè¡Œæ–¹æ³•:
#   cd /root/aws.git/container/claudecode/ArgoCD/ansible
#   ansible-playbook playbooks/deploy_app_version.yml
#
# ã¾ãŸã¯ã€ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š:
#   ansible-playbook playbooks/deploy_app_version.yml -e "app_version=1.2.0"
# ========================================

- name: Deploy Application Version Upgrade
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    project_root: "/root/aws.git/container/claudecode/ArgoCD"
    backend_dir: "{{ project_root }}/app/backend"
    frontend_dir: "{{ project_root }}/app/frontend"
    k8s_manifests_dir: "{{ project_root }}/k8s-manifests"
    app_version: "1.1.0"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ-e ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
    private_ip: "{{ ansible_default_ipv4.address }}"
    version_history_file: "/root/app-version-history.txt"

  tasks:
    # ========================================
    # Phase 0: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¤ãƒ³ãƒ•ãƒ©ç¢ºèª
    # ========================================
    - name: Display deployment information
      debug:
        msg:
          - "=========================================="
          - "Application Version Upgrade Deployment"
          - "=========================================="
          - "Version: {{ app_version }}"
          - "Project Root: {{ project_root }}"
          - "Private IP: {{ private_ip }}"
          - "=========================================="

    - name: Check if K3s is installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_bin

    - name: Fail if K3s is not installed
      fail:
        msg: "K3s is not installed. Please run deploy_k8s_complete.yml first."
      when: not k3s_bin.stat.exists

    - name: Check if ArgoCD is running
      shell: |
        /usr/local/bin/k3s kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server --no-headers | wc -l
      register: argocd_check
      changed_when: false

    - name: Fail if ArgoCD is not running
      fail:
        msg: "ArgoCD is not running. Please run deploy_k8s_complete.yml first."
      when: argocd_check.stdout | int == 0

    - name: Display infrastructure status
      debug:
        msg:
          - "âœ… K3s is running"
          - "âœ… ArgoCD is running"
          - "Ready to deploy application version {{ app_version }}"

    # ========================================
    # Phase 1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
    # ========================================
    - name: "PHASE 1: Build Applications"
      block:
        - name: Check if Maven is installed
          stat:
            path: /usr/bin/mvn
          register: maven_bin

        - name: Build backend with Maven
          command: mvn clean package -DskipTests
          args:
            chdir: "{{ backend_dir }}"
          environment:
            MAVEN_OPTS: "-Xmx512m"
          register: backend_build
          changed_when: true
          when: maven_bin.stat.exists

        - name: Verify backend JAR exists
          stat:
            path: "{{ backend_dir }}/target/orgmgmt-backend.jar"
          register: backend_jar
          failed_when: not backend_jar.stat.exists

        - name: Install frontend dependencies
          command: npm install
          args:
            chdir: "{{ frontend_dir }}"
          register: frontend_deps
          changed_when: true

        - name: Build frontend with Vite
          command: npm run build
          args:
            chdir: "{{ frontend_dir }}"
          register: frontend_build
          changed_when: true

        - name: Verify frontend dist exists
          stat:
            path: "{{ frontend_dir }}/dist"
          register: frontend_dist
          failed_when: not frontend_dist.stat.exists

        - name: Display build status
          debug:
            msg:
              - "âœ… Backend JAR built successfully"
              - "âœ… Frontend dist built successfully"

    # ========================================
    # Phase 2: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
    # ========================================
    - name: "PHASE 2: Build Container Images"
      block:
        - name: Build backend container image with version tag
          command: podman build -t orgmgmt-backend:{{ app_version }} -t orgmgmt-backend:latest -f Dockerfile .
          args:
            chdir: "{{ backend_dir }}"
          register: backend_image
          changed_when: true

        - name: Build frontend container image with version tag
          command: podman build -t orgmgmt-frontend:{{ app_version }} -t orgmgmt-frontend:latest -f Dockerfile .
          args:
            chdir: "{{ frontend_dir }}"
          register: frontend_image
          changed_when: true

        - name: List built images
          command: podman images --filter "reference=orgmgmt-*"
          register: podman_images
          changed_when: false

        - name: Display built images
          debug:
            msg: "{{ podman_images.stdout_lines }}"

    # ========================================
    # Phase 3: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    # ========================================
    - name: "PHASE 3: Export and Import Images to K3s"
      block:
        - name: Remove old export files
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/backend.tar
            - /tmp/frontend.tar
          become: yes

        - name: Export backend image (both tags)
          command: podman save localhost/orgmgmt-backend:{{ app_version }} localhost/orgmgmt-backend:latest -o /tmp/backend.tar
          register: export_backend
          changed_when: true

        - name: Export frontend image (both tags)
          command: podman save localhost/orgmgmt-frontend:{{ app_version }} localhost/orgmgmt-frontend:latest -o /tmp/frontend.tar
          register: export_frontend
          changed_when: true

        - name: Import images into K3s
          shell: |
            /usr/local/bin/k3s ctr images import /tmp/backend.tar
            /usr/local/bin/k3s ctr images import /tmp/frontend.tar
          register: import_images
          changed_when: true

        - name: Verify images in K3s
          shell: |
            /usr/local/bin/k3s crictl images | grep orgmgmt
          register: k3s_images
          changed_when: false

        - name: Display K3s images
          debug:
            msg: "{{ k3s_images.stdout_lines }}"

    # ========================================
    # Phase 4: Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆé©ç”¨
    # ========================================
    - name: "PHASE 4: Apply Kubernetes Manifests"
      block:
        - name: Apply backend deployment
          shell: |
            /usr/local/bin/k3s kubectl apply -f {{ k8s_manifests_dir }}/backend-deployment.yaml
            /usr/local/bin/k3s kubectl apply -f {{ k8s_manifests_dir }}/backend-service.yaml
          register: backend_deploy
          changed_when: '"configured" in backend_deploy.stdout or "created" in backend_deploy.stdout'

        - name: Apply frontend deployment
          shell: |
            /usr/local/bin/k3s kubectl apply -f {{ k8s_manifests_dir }}/frontend-deployment.yaml
            /usr/local/bin/k3s kubectl apply -f {{ k8s_manifests_dir }}/frontend-service.yaml
          register: frontend_deploy
          changed_when: '"configured" in frontend_deploy.stdout or "created" in frontend_deploy.stdout'

        - name: Restart backend deployment (force pull new image)
          command: /usr/local/bin/k3s kubectl rollout restart deployment/orgmgmt-backend
          register: backend_rollout
          changed_when: true

        - name: Restart frontend deployment (force pull new image)
          command: /usr/local/bin/k3s kubectl rollout restart deployment/orgmgmt-frontend
          register: frontend_rollout
          changed_when: true

        - name: Wait for backend rollout to complete
          command: /usr/local/bin/k3s kubectl rollout status deployment/orgmgmt-backend --timeout=300s
          register: backend_rollout_status
          changed_when: false

        - name: Wait for frontend rollout to complete
          command: /usr/local/bin/k3s kubectl rollout status deployment/orgmgmt-frontend --timeout=300s
          register: frontend_rollout_status
          changed_when: false

        - name: Display rollout status
          debug:
            msg:
              - "âœ… Backend deployment rolled out successfully"
              - "âœ… Frontend deployment rolled out successfully"

    # ========================================
    # Phase 5: å‹•ä½œç¢ºèª
    # ========================================
    - name: "PHASE 5: Verify Deployment"
      block:
        - name: Get all pods status
          command: /usr/local/bin/k3s kubectl get pods -o wide
          register: pods_status
          changed_when: false

        - name: Get backend pods with image info
          shell: |
            /usr/local/bin/k3s kubectl get pods -l app=orgmgmt-backend -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\t"}{.status.phase}{"\n"}{end}'
          register: backend_pods_info
          changed_when: false

        - name: Get frontend pods with image info
          shell: |
            /usr/local/bin/k3s kubectl get pods -l app=orgmgmt-frontend -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\t"}{.status.phase}{"\n"}{end}'
          register: frontend_pods_info
          changed_when: false

        - name: Wait for backend health check
          uri:
            url: "http://{{ private_ip }}:8083/actuator/health"
            status_code: 200
            timeout: 5
          register: backend_health
          retries: 30
          delay: 10
          until: backend_health.status == 200

        - name: Wait for frontend to respond
          uri:
            url: "http://{{ private_ip }}:5006/"
            status_code: 200
            timeout: 5
          register: frontend_health
          retries: 10
          delay: 5
          until: frontend_health.status == 200

        - name: Get system info from backend API
          uri:
            url: "http://{{ private_ip }}:8083/api/system/info"
            method: GET
            return_content: yes
          register: system_info
          failed_when: false

        - name: Display deployment verification
          debug:
            msg:
              - "=========================================="
              - "DEPLOYMENT VERIFICATION"
              - "=========================================="
              - ""
              - "Backend Pods:"
              - "{{ backend_pods_info.stdout_lines }}"
              - ""
              - "Frontend Pods:"
              - "{{ frontend_pods_info.stdout_lines }}"
              - ""
              - "Health Checks:"
              - "  Backend API: âœ… {{ backend_health.status }}"
              - "  Frontend: âœ… {{ frontend_health.status }}"
              - ""
              - "All Pods:"
              - "{{ pods_status.stdout_lines }}"
              - ""
              - "=========================================="

        - name: Display system information from API
          debug:
            msg:
              - "System Information from API:"
              - "{{ system_info.json | to_nice_json }}"
          when: system_info.json is defined

    # ========================================
    # Phase 6: ArgoCDåŒæœŸ
    # ========================================
    - name: "PHASE 6: Sync with ArgoCD"
      block:
        - name: Check if ArgoCD Application exists
          shell: |
            /usr/local/bin/k3s kubectl get application orgmgmt-app -n argocd
          register: argocd_app_check
          failed_when: false
          changed_when: false

        - name: Sync ArgoCD Application
          shell: |
            /usr/local/bin/k3s kubectl patch application orgmgmt-app -n argocd \
              --type merge \
              -p '{"operation":{"sync":{"revision":"HEAD"}}}'
          when: argocd_app_check.rc == 0
          register: argocd_sync
          changed_when: true

        - name: Wait for ArgoCD sync
          shell: |
            /usr/local/bin/k3s kubectl get application orgmgmt-app -n argocd -o jsonpath='{.status.sync.status}'
          register: argocd_sync_status
          retries: 10
          delay: 10
          until: argocd_sync_status.stdout == "Synced"
          when: argocd_app_check.rc == 0
          changed_when: false

        - name: Display ArgoCD sync status
          debug:
            msg:
              - "âœ… ArgoCD Application synced"
              - "Status: {{ argocd_sync_status.stdout }}"
          when: argocd_app_check.rc == 0

    # ========================================
    # Phase 7: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´è¨˜éŒ²
    # ========================================
    - name: "PHASE 7: Record Version History"
      block:
        - name: Get deployed backend image
          shell: |
            /usr/local/bin/k3s kubectl get deployment orgmgmt-backend -o jsonpath='{.spec.template.spec.containers[0].image}'
          register: deployed_backend_image
          changed_when: false

        - name: Get deployed frontend image
          shell: |
            /usr/local/bin/k3s kubectl get deployment orgmgmt-frontend -o jsonpath='{.spec.template.spec.containers[0].image}'
          register: deployed_frontend_image
          changed_when: false

        - name: Record deployment in version history
          lineinfile:
            path: "{{ version_history_file }}"
            line: "{{ ansible_date_time.iso8601 }} | DEPLOY | {{ app_version }} | Backend: {{ deployed_backend_image.stdout }}, Frontend: {{ deployed_frontend_image.stdout }}"
            create: yes
            mode: '0644'
          become: no

        - name: Display version history update
          debug:
            msg:
              - "âœ… Version history recorded"
              - "Deployed version: {{ app_version }}"
              - "History file: {{ version_history_file }}"

    # ========================================
    # Phase 8: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚µãƒãƒªãƒ¼
    # ========================================
    - name: Display deployment completion summary
      debug:
        msg:
          - "=========================================="
          - "ğŸ‰ VERSION {{ app_version }} DEPLOYMENT COMPLETE!"
          - "=========================================="
          - ""
          - "âœ… Applications Built"
          - "âœ… Container Images Created ({{ app_version }}, latest)"
          - "âœ… Images Imported to K3s"
          - "âœ… Deployments Rolled Out"
          - "âœ… Health Checks Passed"
          - "âœ… ArgoCD Synced"
          - ""
          - "Access URLs:"
          - "  Frontend:     http://{{ private_ip }}:5006"
          - "  Backend API:  http://{{ private_ip }}:8083"
          - "  System Info:  http://{{ private_ip }}:8083/api/system/info"
          - ""
          - "Next Steps:"
          - "  1. Access frontend: http://{{ private_ip }}:5006"
          - "  2. Check 'System Information' card on homepage"
          - "  3. Verify Pod names and session tracking"
          - "  4. Test application functionality"
          - ""
          - "Rollback (if needed):"
          - "  kubectl set image deployment/orgmgmt-backend backend=localhost/orgmgmt-backend:1.0.0"
          - "  kubectl set image deployment/orgmgmt-frontend frontend=localhost/orgmgmt-frontend:1.0.0"
          - ""
          - "=========================================="
