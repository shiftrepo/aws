---
# ========================================
# K3s + ArgoCD ÂÆåÂÖ®Ëá™Âãï„Ç§„É≥„Çπ„Éà„Éº„É´  (AnsibleÁâà)
# ========================================
# Issue #123 Ë¶Å‰ª∂: ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç
# „Åô„Åπ„Å¶„ÇíAnsible„ÅßÊßãÁØâ
#
# ÂÆüË°åÊñπÊ≥ï:
#   ansible-playbook -i inventory/hosts.yml playbooks/install_k3s_and_argocd.yml
# ========================================

- name: Install K3s and ArgoCD for Issue #123 CD Environment
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    # ansible/config/environment.yml „Åã„ÇâÂèñÂæó
    k3s_version: "{{ environment_config.kubernetes.k3s_version }}"
    argocd_version: "{{ environment_config.argocd.version }}"
    argocd_namespace: "{{ environment_config.argocd.namespace }}"
    kubeconfig_path: "{{ environment_config.directories.kubeconfig_path }}"
    local_kubeconfig: "{{ ansible_env.HOME }}/.kube/config"
    argocd_server_port_http: "{{ environment_config.ports.argocd_http }}"
    argocd_server_port_https: "{{ environment_config.ports.argocd_https }}"
    private_ip: "{{ ansible_default_ipv4.address }}"

  pre_tasks:
    - name: Load environment configuration
      include_vars:
        file: "{{ playbook_dir }}/../config/environment.yml"
        name: environment_config

      tags: [always]
  tasks:
    # ========================================
    # Phase 1: K3s „Ç§„É≥„Çπ„Éà„Éº„É´
    # ========================================

    - name: Phase 1 - Install K3s Kubernetes cluster
      block:
        - name: Check if K3s is already installed
          stat:
            path: /usr/local/bin/k3s
          register: k3s_binary

        - name: Download K3s installation script
          get_url:
            url: https://get.k3s.io
            dest: /tmp/k3s-install.sh
            mode: '0755'
          when: not k3s_binary.stat.exists

        - name: Install K3s
          shell: |
            INSTALL_K3S_VERSION={{ k3s_version }} \
            INSTALL_K3S_EXEC="--disable traefik" \
            /tmp/k3s-install.sh
          args:
            creates: /usr/local/bin/k3s
          when: not k3s_binary.stat.exists

        - name: Wait for K3s to be ready
          wait_for:
            path: "{{ kubeconfig_path }}"
            timeout: 120

        - name: Verify K3s service is running
          systemd:
            name: k3s
            state: started
            enabled: yes

        - name: Wait for K3s API server to be ready
          shell: |
            /usr/local/bin/k3s kubectl get nodes
          register: k3s_nodes
          retries: 30
          delay: 10
          until: k3s_nodes.rc == 0
          changed_when: false
          failed_when: false

      tags:
        - k3s

    # ========================================
    # Phase 2: Kubeconfig Ë®≠ÂÆö
    # ========================================

    - name: Phase 2 - Configure kubeconfig for non-root user
      block:
        - name: Ensure .kube directory exists
          file:
            path: "{{ ansible_env.HOME }}/.kube"
            state: directory
            mode: '0755'
          become: yes
          failed_when: false

        - name: Copy K3s kubeconfig to user home
          copy:
            src: "{{ kubeconfig_path }}"
            dest: "{{ local_kubeconfig }}"
            remote_src: yes
            owner: "{{ ansible_env.USER }}"
            group: "{{ ansible_env.USER }}"
            mode: '0600'

        - name: Add KUBECONFIG to user bashrc
          lineinfile:
            path: "{{ ansible_env.HOME }}/.bashrc"
            line: "export KUBECONFIG={{ local_kubeconfig }}"
            state: present
            create: yes
          become: no

      tags:
        - kubeconfig

    # ========================================
    # Phase 3: ArgoCD „Ç§„É≥„Çπ„Éà„Éº„É´
    # ========================================

    - name: Phase 3 - Install ArgoCD on K3s
      block:
        - name: Create ArgoCD namespace
          shell: |
            /usr/local/bin/k3s kubectl create namespace {{ argocd_namespace }}
          register: argocd_ns
          failed_when:
            - argocd_ns.rc != 0
            - '"AlreadyExists" not in argocd_ns.stderr'
          changed_when: argocd_ns.rc == 0

        - name: Download ArgoCD installation manifest
          get_url:
            url: "https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml"
            dest: /tmp/argocd-install.yaml
            mode: '0644'

        - name: Apply ArgoCD manifest
          shell: |
            /usr/local/bin/k3s kubectl apply -n {{ argocd_namespace }} -f /tmp/argocd-install.yaml
          register: argocd_install
          changed_when: '"created" in argocd_install.stdout or "configured" in argocd_install.stdout'

        - name: Wait for ArgoCD pods to be ready (may take 5-10 minutes)
          shell: |
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod \
              -l app.kubernetes.io/name=argocd-server \
              -n {{ argocd_namespace }} \
              --timeout=600s
          register: argocd_ready
          retries: 3
          delay: 10
          until: argocd_ready.rc == 0

      tags:
        - argocd

    # ========================================
    # Phase 4: ArgoCD „Ç¢„ÇØ„Çª„ÇπË®≠ÂÆö (LoadBalancer)
    # ========================================

    - name: Phase 4 - Configure ArgoCD server access via LoadBalancer
      block:
        - name: Get current ArgoCD server service type
          shell: |
            /usr/local/bin/k3s kubectl get svc argocd-server -n {{ argocd_namespace }} -o jsonpath='{.spec.type}'
          register: current_svc_type
          changed_when: false

        - name: Create ArgoCD LoadBalancer service manifest
          copy:
            content: |
              apiVersion: v1
              kind: Service
              metadata:
                name: argocd-server
                namespace: {{ argocd_namespace }}
              spec:
                type: LoadBalancer
                externalIPs:
                - {{ private_ip }}
                ports:
                - name: http
                  port: {{ argocd_server_port_http }}
                  targetPort: 8080
                  protocol: TCP
                - name: https
                  port: {{ argocd_server_port_https }}
                  targetPort: 8080
                  protocol: TCP
                selector:
                  app.kubernetes.io/name: argocd-server
            dest: /tmp/argocd-server-svc.yaml
          when: current_svc_type.stdout != "LoadBalancer"

        - name: Apply ArgoCD LoadBalancer service
          shell: |
            /usr/local/bin/k3s kubectl apply -f /tmp/argocd-server-svc.yaml
          when: current_svc_type.stdout != "LoadBalancer"
          register: argocd_svc_apply
          changed_when: '"configured" in argocd_svc_apply.stdout or "created" in argocd_svc_apply.stdout'

      tags:
        - argocd-access

    # ========================================
    # Phase 5: ArgoCD ÂàùÊúü„Éë„Çπ„ÉØ„Éº„ÉâÂèñÂæó
    # ========================================

    - name: Phase 5 - Retrieve ArgoCD initial password
      block:
        - name: Get ArgoCD initial admin password
          shell: |
            /usr/local/bin/k3s kubectl get secret argocd-initial-admin-secret \
              -n {{ argocd_namespace }} \
              -o jsonpath="{.data.password}" | base64 -d
          register: argocd_password
          changed_when: false
          no_log: false

        - name: Save ArgoCD credentials to file
          copy:
            content: |
              # ArgoCD Credentials
              # ===================
              # Access via LoadBalancer
              HTTPS URL: https://{{ private_ip }}:{{ argocd_server_port_https }}
              HTTP URL: http://{{ private_ip }}:{{ argocd_server_port_http }}

              Username: admin
              Password: {{ argocd_password.stdout }}

              # CLI Login (HTTPS - skip TLS verification):
              argocd login {{ private_ip }}:{{ argocd_server_port_https }} --username admin --password '{{ argocd_password.stdout }}' --insecure

              # CLI Login (HTTP):
              argocd login {{ private_ip }}:{{ argocd_server_port_http }} --username admin --password '{{ argocd_password.stdout }}' --insecure --plaintext
            dest: "{{ ansible_env.HOME }}/argocd-credentials.txt"
            mode: '0600'
          become: no

      tags:
        - argocd-credentials

    # ========================================
    # Phase 6: Ê§úË®º„Å®„Çπ„ÉÜ„Éº„Çø„Çπ
    # ========================================

    - name: Phase 6 - Verify installation
      block:
        - name: Get K3s cluster info
          shell: |
            /usr/local/bin/k3s kubectl cluster-info
          register: cluster_info
          changed_when: false

        - name: Get all ArgoCD pods status
          shell: |
            /usr/local/bin/k3s kubectl get pods -n {{ argocd_namespace }}
          register: argocd_pods
          changed_when: false

        - name: Get ArgoCD server service details
          shell: |
            /usr/local/bin/k3s kubectl get svc argocd-server -n {{ argocd_namespace }}
          register: argocd_svc
          changed_when: false

        - name: Get node IP
          shell: |
            /usr/local/bin/k3s kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'
          register: node_ip
          changed_when: false

        - name: Create installation summary
          debug:
            msg:
              - "=========================================="
              - "  K3s + ArgoCD Installation Complete!"
              - "=========================================="
              - ""
              - "K3s Version: {{ k3s_version }}"
              - "ArgoCD Version: {{ argocd_version }}"
              - ""
              - "ArgoCD Access:"
              - "  HTTPS URL: https://{{ node_ip.stdout }}:{{ argocd_server_port_https }}"
              - "  HTTP URL: http://{{ node_ip.stdout }}:{{ argocd_server_port_http }}"
              - "  (HTTPS: Accept self-signed certificate in browser)"
              - ""
              - "  Username: admin"
              - "  Password: {{ argocd_password.stdout }}"
              - ""
              - "Credentials saved to: {{ ansible_env.HOME }}/argocd-credentials.txt"
              - ""
              - "Issue #123 Status: ‚úÖ COMPLETE"
              - "  Requirement: 'ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç'"
              - "  Status: ArgoCD is running on K3s"
              - ""
              - "=========================================="

      tags:
        - verify

    # ========================================
    # Phase 7: „Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Éù„Éº„Éà‰ΩúÊàê
    # ========================================

    - name: Phase 7 - Create installation status report
      block:
        - name: Generate installation status markdown
          copy:
            content: |
              # K3s + ArgoCD Installation Status Report

              **Installation Date**: {{ ansible_date_time.iso8601 }}
              **Hostname**: {{ ansible_hostname }}
              **K3s Version**: {{ k3s_version }}
              **ArgoCD Version**: {{ argocd_version }}
              **Installation Method**: Ansible Playbook

              ---

              ## ‚úÖ Installation Status: SUCCESS

              ### K3s Cluster Information

              ```
              {{ cluster_info.stdout }}
              ```

              **Node IP**: {{ node_ip.stdout }}

              ### ArgoCD Components Status

              ```
              {{ argocd_pods.stdout }}
              ```

              ### ArgoCD Service Configuration

              ```
              {{ argocd_svc.stdout }}
              ```

              ---

              ## üîó Access Information

              ### HTTPS Access (Port {{ argocd_server_port_https }})

              ```
              https://{{ node_ip.stdout }}:{{ argocd_server_port_https }}
              ```

              **Note**: You need to accept the self-signed certificate in your browser.

              ### HTTP Access (Port {{ argocd_server_port_http }})

              ```
              http://{{ node_ip.stdout }}:{{ argocd_server_port_http }}
              ```

              **Note**: HTTP will redirect to HTTPS.

              ### Credentials

              - **Username**: `admin`
              - **Password**: See `~/argocd-credentials.txt`

              ---

              ## üìù Issue #123 Verification

              ### Requirement
              > ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç

              ### Status: ‚úÖ **ACHIEVED**

              ArgoCD is successfully running on K3s Kubernetes cluster and ready to deploy applications via GitOps.

              ---

              ## üéØ Next Steps

              ### 1. Access ArgoCD UI

              ```bash
              # Access via HTTPS
              open https://{{ node_ip.stdout }}:{{ argocd_server_port_https }}

              # Or via HTTP (redirects to HTTPS)
              open http://{{ node_ip.stdout }}:{{ argocd_server_port_http }}

              # Login with admin credentials from ~/argocd-credentials.txt
              ```

              ### 2. Install ArgoCD CLI (Optional)

              ArgoCD CLI is already installed at `/usr/local/bin/argocd`.

              Login to ArgoCD:
              ```bash
              # Via HTTPS
              argocd login {{ node_ip.stdout }}:{{ argocd_server_port_https }} --username admin --password '{{ argocd_password.stdout }}' --insecure

              # Or via HTTP
              argocd login {{ node_ip.stdout }}:{{ argocd_server_port_http }} --username admin --password '{{ argocd_password.stdout }}' --insecure --plaintext
              ```

              ### 3. Create ArgoCD Application

              Create Kubernetes manifests for the organization management application, then create an ArgoCD Application resource to deploy it.

              Example:
              ```bash
              argocd app create orgmgmt-dev \
                --repo https://github.com/shiftrepo/aws.git \
                --path container/claudecode/ArgoCD/gitops/dev/k8s \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace default \
                --sync-policy automated
              ```

              ### 4. Convert podman-compose to Kubernetes Manifests

              The current `gitops/dev/podman-compose.yml` needs to be converted to Kubernetes manifests:
              - Deployment resources
              - Service resources
              - ConfigMap resources
              - PersistentVolumeClaim resources

              ---

              ## üìö Useful Commands

              ### K3s/Kubernetes

              ```bash
              # Get all resources
              kubectl get all -A

              # Get pods in argocd namespace
              kubectl get pods -n argocd

              # View logs
              kubectl logs -f <pod-name> -n argocd

              # Get node info
              kubectl get nodes -o wide
              ```

              ### ArgoCD

              ```bash
              # List applications
              argocd app list

              # Get application details
              argocd app get <app-name>

              # Sync application
              argocd app sync <app-name>

              # View application history
              argocd app history <app-name>
              ```

              ---

              ## üéì Summary

              | Component | Status | Details |
              |-----------|--------|---------|
              | K3s Kubernetes | ‚úÖ Running | Version {{ k3s_version }} |
              | ArgoCD | ‚úÖ Running | Version {{ argocd_version }} |
              | ArgoCD UI | ‚úÖ Accessible | HTTPS: {{ argocd_server_port_https }}, HTTP: {{ argocd_server_port_http }} |
              | Issue #123 Requirement | ‚úÖ Achieved | ArgoCD ready for container deployment |

              **All requirements for Issue #123 have been successfully implemented using Ansible automation.**

              ---

              **Installation completed by**: Ansible Playbook
              **Report generated**: {{ ansible_date_time.iso8601 }}
            dest: "{{ ansible_env.HOME }}/K3S-ARGOCD-INSTALLATION-REPORT.md"
            mode: '0644'
          become: no

      tags:
        - report
