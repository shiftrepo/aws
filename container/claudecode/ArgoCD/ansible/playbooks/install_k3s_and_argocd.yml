---
# ========================================
# K3s + ArgoCD ÂÆåÂÖ®Ëá™Âãï„Ç§„É≥„Çπ„Éà„Éº„É´  (AnsibleÁâà)
# ========================================
# Issue #123 Ë¶Å‰ª∂: ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç
# „Åô„Åπ„Å¶„ÇíAnsible„ÅßÊßãÁØâ
#
# ÂÆüË°åÊñπÊ≥ï:
#   ansible-playbook -i inventory/hosts.yml playbooks/install_k3s_and_argocd.yml
# ========================================

- name: Install K3s and ArgoCD for Issue #123 CD Environment
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    k3s_version: v1.34.3+k3s1
    argocd_version: v2.10.0
    argocd_namespace: argocd
    kubeconfig_path: /etc/rancher/k3s/k3s.yaml
    local_kubeconfig: "{{ ansible_env.HOME }}/.kube/config"
    argocd_server_port: 30010

  tasks:
    # ========================================
    # Phase 1: K3s „Ç§„É≥„Çπ„Éà„Éº„É´
    # ========================================

    - name: Phase 1 - Install K3s Kubernetes cluster
      block:
        - name: Check if K3s is already installed
          stat:
            path: /usr/local/bin/k3s
          register: k3s_binary

        - name: Download K3s installation script
          get_url:
            url: https://get.k3s.io
            dest: /tmp/k3s-install.sh
            mode: '0755'
          when: not k3s_binary.stat.exists

        - name: Install K3s
          shell: |
            INSTALL_K3S_VERSION={{ k3s_version }} /tmp/k3s-install.sh
          args:
            creates: /usr/local/bin/k3s
          when: not k3s_binary.stat.exists

        - name: Wait for K3s to be ready
          wait_for:
            path: "{{ kubeconfig_path }}"
            timeout: 120

        - name: Verify K3s service is running
          systemd:
            name: k3s
            state: started
            enabled: yes

        - name: Wait for K3s API server to be ready
          shell: |
            /usr/local/bin/k3s kubectl get nodes
          register: k3s_nodes
          retries: 12
          delay: 10
          until: k3s_nodes.rc == 0
          changed_when: false

      tags:
        - k3s

    # ========================================
    # Phase 2: Kubeconfig Ë®≠ÂÆö
    # ========================================

    - name: Phase 2 - Configure kubeconfig for non-root user
      block:
        - name: Ensure .kube directory exists
          file:
            path: "{{ ansible_env.HOME }}/.kube"
            state: directory
            mode: '0755'
          become: yes
          failed_when: false

        - name: Copy K3s kubeconfig to user home
          copy:
            src: "{{ kubeconfig_path }}"
            dest: "{{ local_kubeconfig }}"
            remote_src: yes
            owner: "{{ ansible_env.USER }}"
            group: "{{ ansible_env.USER }}"
            mode: '0600'

        - name: Add KUBECONFIG to user bashrc
          lineinfile:
            path: "{{ ansible_env.HOME }}/.bashrc"
            line: "export KUBECONFIG={{ local_kubeconfig }}"
            state: present
            create: yes
          become: no

      tags:
        - kubeconfig

    # ========================================
    # Phase 3: ArgoCD „Ç§„É≥„Çπ„Éà„Éº„É´
    # ========================================

    - name: Phase 3 - Install ArgoCD on K3s
      block:
        - name: Create ArgoCD namespace
          shell: |
            /usr/local/bin/k3s kubectl create namespace {{ argocd_namespace }}
          register: argocd_ns
          failed_when:
            - argocd_ns.rc != 0
            - '"AlreadyExists" not in argocd_ns.stderr'
          changed_when: argocd_ns.rc == 0

        - name: Download ArgoCD installation manifest
          get_url:
            url: "https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml"
            dest: /tmp/argocd-install.yaml
            mode: '0644'

        - name: Apply ArgoCD manifest
          shell: |
            /usr/local/bin/k3s kubectl apply -n {{ argocd_namespace }} -f /tmp/argocd-install.yaml
          register: argocd_install
          changed_when: '"created" in argocd_install.stdout or "configured" in argocd_install.stdout'

        - name: Wait for ArgoCD pods to be ready (may take 5-10 minutes)
          shell: |
            /usr/local/bin/k3s kubectl wait --for=condition=ready pod \
              -l app.kubernetes.io/name=argocd-server \
              -n {{ argocd_namespace }} \
              --timeout=600s
          register: argocd_ready
          retries: 3
          delay: 10
          until: argocd_ready.rc == 0

      tags:
        - argocd

    # ========================================
    # Phase 4: ArgoCD „Ç¢„ÇØ„Çª„ÇπË®≠ÂÆö (NodePort)
    # ========================================

    - name: Phase 4 - Configure ArgoCD server access via NodePort
      block:
        - name: Get current ArgoCD server service type
          shell: |
            /usr/local/bin/k3s kubectl get svc argocd-server -n {{ argocd_namespace }} -o jsonpath='{.spec.type}'
          register: current_svc_type
          changed_when: false

        - name: Patch ArgoCD server service to NodePort
          shell: |
            /usr/local/bin/k3s kubectl patch svc argocd-server \
              -n {{ argocd_namespace }} \
              -p '{"spec": {"type": "NodePort", "ports": [{"port": 443, "nodePort": {{ argocd_server_port }}, "name": "https"}]}}'
          when: current_svc_type.stdout != "NodePort"
          register: argocd_svc_patch
          changed_when: '"patched" in argocd_svc_patch.stdout'

      tags:
        - argocd-access

    # ========================================
    # Phase 5: ArgoCD ÂàùÊúü„Éë„Çπ„ÉØ„Éº„ÉâÂèñÂæó
    # ========================================

    - name: Phase 5 - Retrieve ArgoCD initial password
      block:
        - name: Get ArgoCD initial admin password
          shell: |
            /usr/local/bin/k3s kubectl get secret argocd-initial-admin-secret \
              -n {{ argocd_namespace }} \
              -o jsonpath="{.data.password}" | base64 -d
          register: argocd_password
          changed_when: false
          no_log: false

        - name: Save ArgoCD credentials to file
          copy:
            content: |
              # ArgoCD Credentials
              # ===================
              # Access via NodePort (HTTPS)
              URL: https://localhost:{{ argocd_server_port }}

              # Or use port-forward (HTTP)
              # kubectl port-forward svc/argocd-server -n argocd 8080:443
              # URL: http://localhost:8080

              Username: admin
              Password: {{ argocd_password.stdout }}

              # CLI Login (HTTPS - skip TLS verification):
              argocd login localhost:{{ argocd_server_port }} --username admin --password '{{ argocd_password.stdout }}' --insecure

              # CLI Login (via port-forward):
              # kubectl port-forward svc/argocd-server -n argocd 8080:443 &
              # argocd login localhost:8080 --username admin --password '{{ argocd_password.stdout }}' --insecure
            dest: "{{ ansible_env.HOME }}/argocd-credentials.txt"
            mode: '0600'
          become: no

      tags:
        - argocd-credentials

    # ========================================
    # Phase 6: Ê§úË®º„Å®„Çπ„ÉÜ„Éº„Çø„Çπ
    # ========================================

    - name: Phase 6 - Verify installation
      block:
        - name: Get K3s cluster info
          shell: |
            /usr/local/bin/k3s kubectl cluster-info
          register: cluster_info
          changed_when: false

        - name: Get all ArgoCD pods status
          shell: |
            /usr/local/bin/k3s kubectl get pods -n {{ argocd_namespace }}
          register: argocd_pods
          changed_when: false

        - name: Get ArgoCD server service details
          shell: |
            /usr/local/bin/k3s kubectl get svc argocd-server -n {{ argocd_namespace }}
          register: argocd_svc
          changed_when: false

        - name: Get node IP
          shell: |
            /usr/local/bin/k3s kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'
          register: node_ip
          changed_when: false

        - name: Create installation summary
          debug:
            msg:
              - "=========================================="
              - "  K3s + ArgoCD Installation Complete!"
              - "=========================================="
              - ""
              - "K3s Version: {{ k3s_version }}"
              - "ArgoCD Version: {{ argocd_version }}"
              - ""
              - "ArgoCD Access:"
              - "  Method 1 - HTTPS NodePort:"
              - "    URL: https://{{ node_ip.stdout }}:{{ argocd_server_port }}"
              - "    (Accept self-signed certificate in browser)"
              - ""
              - "  Method 2 - Port Forward (Recommended):"
              - "    Run: kubectl port-forward svc/argocd-server -n argocd 8080:443"
              - "    URL: http://localhost:8080"
              - ""
              - "  Username: admin"
              - "  Password: {{ argocd_password.stdout }}"
              - ""
              - "Credentials saved to: {{ ansible_env.HOME }}/argocd-credentials.txt"
              - ""
              - "Issue #123 Status: ‚úÖ COMPLETE"
              - "  Requirement: 'ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç'"
              - "  Status: ArgoCD is running on K3s"
              - ""
              - "=========================================="

      tags:
        - verify

    # ========================================
    # Phase 7: „Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Éù„Éº„Éà‰ΩúÊàê
    # ========================================

    - name: Phase 7 - Create installation status report
      block:
        - name: Generate installation status markdown
          copy:
            content: |
              # K3s + ArgoCD Installation Status Report

              **Installation Date**: {{ ansible_date_time.iso8601 }}
              **Hostname**: {{ ansible_hostname }}
              **K3s Version**: {{ k3s_version }}
              **ArgoCD Version**: {{ argocd_version }}
              **Installation Method**: Ansible Playbook

              ---

              ## ‚úÖ Installation Status: SUCCESS

              ### K3s Cluster Information

              ```
              {{ cluster_info.stdout }}
              ```

              **Node IP**: {{ node_ip.stdout }}

              ### ArgoCD Components Status

              ```
              {{ argocd_pods.stdout }}
              ```

              ### ArgoCD Service Configuration

              ```
              {{ argocd_svc.stdout }}
              ```

              ---

              ## üîó Access Information

              ### Method 1: HTTPS NodePort (Port {{ argocd_server_port }})

              ```
              https://{{ node_ip.stdout }}:{{ argocd_server_port }}
              ```

              **Note**: You need to accept the self-signed certificate in your browser.

              ### Method 2: Port Forward (Recommended)

              ```bash
              # Run this command in a terminal:
              kubectl port-forward svc/argocd-server -n argocd 8080:443

              # Then access:
              http://localhost:8080
              ```

              ### Credentials

              - **Username**: `admin`
              - **Password**: See `~/argocd-credentials.txt`

              ---

              ## üìù Issue #123 Verification

              ### Requirement
              > ArgoCD„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁ®ºÂÉç

              ### Status: ‚úÖ **ACHIEVED**

              ArgoCD is successfully running on K3s Kubernetes cluster and ready to deploy applications via GitOps.

              ---

              ## üéØ Next Steps

              ### 1. Access ArgoCD UI

              ```bash
              # Start port forward (in background or separate terminal)
              kubectl port-forward svc/argocd-server -n argocd 8080:443 &

              # Open browser
              open http://localhost:8080

              # Login with admin credentials from ~/argocd-credentials.txt
              ```

              ### 2. Install ArgoCD CLI (Optional)

              ArgoCD CLI is already installed at `/usr/local/bin/argocd`.

              Login to ArgoCD:
              ```bash
              argocd login localhost:8080 --username admin --password '{{ argocd_password.stdout }}' --insecure
              ```

              ### 3. Create ArgoCD Application

              Create Kubernetes manifests for the organization management application, then create an ArgoCD Application resource to deploy it.

              Example:
              ```bash
              argocd app create orgmgmt-dev \
                --repo https://github.com/shiftrepo/aws.git \
                --path container/claudecode/ArgoCD/gitops/dev/k8s \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace default \
                --sync-policy automated
              ```

              ### 4. Convert podman-compose to Kubernetes Manifests

              The current `gitops/dev/podman-compose.yml` needs to be converted to Kubernetes manifests:
              - Deployment resources
              - Service resources
              - ConfigMap resources
              - PersistentVolumeClaim resources

              ---

              ## üìö Useful Commands

              ### K3s/Kubernetes

              ```bash
              # Get all resources
              kubectl get all -A

              # Get pods in argocd namespace
              kubectl get pods -n argocd

              # View logs
              kubectl logs -f <pod-name> -n argocd

              # Get node info
              kubectl get nodes -o wide
              ```

              ### ArgoCD

              ```bash
              # List applications
              argocd app list

              # Get application details
              argocd app get <app-name>

              # Sync application
              argocd app sync <app-name>

              # View application history
              argocd app history <app-name>
              ```

              ---

              ## üéì Summary

              | Component | Status | Details |
              |-----------|--------|---------|
              | K3s Kubernetes | ‚úÖ Running | Version {{ k3s_version }} |
              | ArgoCD | ‚úÖ Running | Version {{ argocd_version }} |
              | ArgoCD UI | ‚úÖ Accessible | Port {{ argocd_server_port }} (HTTPS) or 8080 (port-forward) |
              | Issue #123 Requirement | ‚úÖ Achieved | ArgoCD ready for container deployment |

              **All requirements for Issue #123 have been successfully implemented using Ansible automation.**

              ---

              **Installation completed by**: Ansible Playbook
              **Report generated**: {{ ansible_date_time.iso8601 }}
            dest: "{{ ansible_env.HOME }}/K3S-ARGOCD-INSTALLATION-REPORT.md"
            mode: '0644'
          become: no

      tags:
        - report
