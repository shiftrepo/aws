---
- name: Complete ArgoCD Infrastructure Setup
  hosts: localhost
  gather_facts: yes

  tasks:
    - name: Display setup banner
      debug:
        msg:
          - "=========================================="
          - "ArgoCD Infrastructure Complete Setup"
          - "=========================================="
          - ""
          - "This playbook will:"
          - "  1. Configure Podman insecure registry"
          - "  2. Install ArgoCD CLI"
          - "  3. Deploy infrastructure with podman-compose"
          - "  4. Setup application components"
          - ""
          - "Starting setup process..."
          - "=========================================="

    - name: Wait for user confirmation
      pause:
        prompt: "Press ENTER to continue with the setup, or Ctrl+C to abort"
      when: lookup('env', 'ANSIBLE_AUTO_CONTINUE') | default('false') != 'true'

# ==========================================
# Step 1: Configure Podman Registry
# ==========================================
- name: Step 1 - Configure Podman Insecure Registry
  import_playbook: configure_podman_registry.yml
  tags:
    - registry
    - podman

# ==========================================
# Step 2: Install ArgoCD CLI
# ==========================================
- name: Step 2 - Install ArgoCD CLI
  import_playbook: install_argocd.yml
  tags:
    - argocd
    - cli

# ==========================================
# Step 3: Deploy Infrastructure
# ==========================================
- name: Step 3 - Deploy Infrastructure
  import_playbook: deploy_infrastructure.yml
  tags:
    - infrastructure
    - deploy

# ==========================================
# Step 4: Setup Application Components
# ==========================================
- name: Step 4 - Setup Application Components
  import_playbook: setup_application.yml
  tags:
    - application
    - setup

# ==========================================
# Final Summary
# ==========================================
- name: Display Final Summary
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Display completion summary
      debug:
        msg:
          - "=========================================="
          - "ArgoCD Infrastructure Setup Complete!"
          - "=========================================="
          - ""
          - "All components have been configured:"
          - "  [✓] Podman insecure registry configured"
          - "  [✓] ArgoCD CLI installed"
          - "  [✓] Infrastructure deployed"
          - "  [✓] Application components initialized"
          - ""
          - "Service Access URLs:"
          - "  - PostgreSQL: localhost:5432"
          - "  - pgAdmin: http://localhost:5050"
          - "  - Nexus: http://localhost:8081"
          - "  - GitLab: http://localhost:5003"
          - "  - GitLab Registry: http://localhost:5005"
          - "  - ArgoCD: http://localhost:5010"
          - ""
          - "Next Steps:"
          - "  1. Access ArgoCD at http://localhost:5010"
          - "  2. Configure GitLab projects and CI/CD pipelines"
          - "  3. Set up Nexus repositories"
          - "  4. Create ArgoCD applications"
          - "  5. Deploy your applications"
          - ""
          - "For individual component setup, run:"
          - "  ansible-playbook playbooks/<playbook-name>.yml"
          - ""
          - "Available playbooks:"
          - "  - configure_podman_registry.yml"
          - "  - install_argocd.yml"
          - "  - deploy_infrastructure.yml"
          - "  - setup_application.yml"
          - ""
          - "Use tags to run specific steps:"
          - "  ansible-playbook playbooks/site.yml --tags registry"
          - "  ansible-playbook playbooks/site.yml --tags infrastructure"
          - ""
          - "=========================================="

    - name: Create quick reference script
      copy:
        dest: "{{ playbook_dir }}/../ansible-commands.sh"
        mode: '0755'
        content: |
          #!/bin/bash
          # Ansible Quick Reference Commands
          # Generated by site.yml playbook

          echo "=========================================="
          echo "Ansible Playbook Quick Reference"
          echo "=========================================="
          echo ""
          echo "Run all playbooks in sequence:"
          echo "  ansible-playbook playbooks/site.yml"
          echo ""
          echo "Run specific playbooks:"
          echo "  ansible-playbook playbooks/configure_podman_registry.yml"
          echo "  ansible-playbook playbooks/install_argocd.yml"
          echo "  ansible-playbook playbooks/deploy_infrastructure.yml"
          echo "  ansible-playbook playbooks/setup_application.yml"
          echo ""
          echo "Run with tags:"
          echo "  ansible-playbook playbooks/site.yml --tags registry"
          echo "  ansible-playbook playbooks/site.yml --tags cli"
          echo "  ansible-playbook playbooks/site.yml --tags infrastructure"
          echo "  ansible-playbook playbooks/site.yml --tags application"
          echo ""
          echo "Skip confirmation prompt:"
          echo "  ANSIBLE_AUTO_CONTINUE=true ansible-playbook playbooks/site.yml"
          echo ""
          echo "Dry run (check mode):"
          echo "  ansible-playbook playbooks/site.yml --check"
          echo ""
          echo "Verbose output:"
          echo "  ansible-playbook playbooks/site.yml -v"
          echo "  ansible-playbook playbooks/site.yml -vv"
          echo "  ansible-playbook playbooks/site.yml -vvv"
          echo ""
          echo "=========================================="
      delegate_to: localhost

    - name: Display quick reference location
      debug:
        msg: "Quick reference script created at {{ playbook_dir }}/../ansible-commands.sh"
