---
# ========================================
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
# ========================================
# ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã—ã¾ã™
#
# å‰ææ¡ä»¶:
#   - K3sã¨ArgoCDãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
#   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿
#
# å®Ÿè¡Œæ–¹æ³•:
#   cd /root/aws.git/container/claudecode/ArgoCD/ansible
#
#   # ç›´å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
#   ansible-playbook playbooks/rollback_app_version.yml
#
#   # ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
#   ansible-playbook playbooks/rollback_app_version.yml -e "target_version=1.0.0"
#
#   # ç‰¹å®šã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
#   ansible-playbook playbooks/rollback_app_version.yml -e "target_revision=1"
# ========================================

- name: Rollback Application Version
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    project_root: "/root/aws.git/container/claudecode/ArgoCD"
    backend_dir: "{{ project_root }}/app/backend"
    frontend_dir: "{{ project_root }}/app/frontend"
    k8s_manifests_dir: "{{ project_root }}/k8s-manifests"
    private_ip: "{{ ansible_default_ipv4.address }}"
    version_history_file: "/root/app-version-history.txt"
    target_version: ""  # ç©ºã®å ´åˆã¯ç›´å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
    target_revision: ""  # ç©ºã®å ´åˆã¯kubectl rollout undoã‚’ä½¿ç”¨

  tasks:
    # ========================================
    # Phase 0: ç’°å¢ƒç¢ºèªã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´å–å¾—
    # ========================================
    - name: Display rollback information
      debug:
        msg:
          - "=========================================="
          - "Application Version Rollback"
          - "=========================================="
          - "Private IP: {{ private_ip }}"
          - "Target Version: {{ target_version if target_version else 'Previous version' }}"
          - "Target Revision: {{ target_revision if target_revision else 'Auto (rollout undo)' }}"
          - "=========================================="

    - name: Check if K3s is installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_bin

    - name: Fail if K3s is not installed
      fail:
        msg: "K3s is not installed. Cannot perform rollback."
      when: not k3s_bin.stat.exists

    - name: Get current backend deployment revision
      shell: |
        /usr/local/bin/k3s kubectl rollout history deployment/orgmgmt-backend | tail -1
      register: backend_current_revision
      changed_when: false

    - name: Get current frontend deployment revision
      shell: |
        /usr/local/bin/k3s kubectl rollout history deployment/orgmgmt-frontend | tail -1
      register: frontend_current_revision
      changed_when: false

    - name: Get current backend image
      shell: |
        /usr/local/bin/k3s kubectl get deployment orgmgmt-backend -o jsonpath='{.spec.template.spec.containers[0].image}'
      register: current_backend_image
      changed_when: false

    - name: Get current frontend image
      shell: |
        /usr/local/bin/k3s kubectl get deployment orgmgmt-frontend -o jsonpath='{.spec.template.spec.containers[0].image}'
      register: current_frontend_image
      changed_when: false

    - name: Display current deployment status
      debug:
        msg:
          - "Current Deployment Status:"
          - "  Backend Image: {{ current_backend_image.stdout }}"
          - "  Frontend Image: {{ current_frontend_image.stdout }}"
          - "  Backend Revision: {{ backend_current_revision.stdout }}"
          - "  Frontend Revision: {{ frontend_current_revision.stdout }}"

    - name: Check version history file exists
      stat:
        path: "{{ version_history_file }}"
      register: version_history_stat

    - name: Display version history if exists
      block:
        - name: Read version history
          command: cat {{ version_history_file }}
          register: version_history_content
          changed_when: false

        - name: Show version history
          debug:
            msg:
              - "Version History:"
              - "{{ version_history_content.stdout_lines }}"
      when: version_history_stat.stat.exists

    # ========================================
    # Phase 1: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
    # ========================================
    - name: "PHASE 1: Perform Rollback"
      block:
        # ã‚±ãƒ¼ã‚¹1: ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼ˆGitã‚¿ã‚°ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ï¼‰
        - name: Rollback to specific version (build from Git tag)
          block:
            - name: Check if Git tag exists
              command: git tag -l argocd-regression-v{{ target_version }}
              args:
                chdir: "{{ project_root }}"
              register: git_tag_check
              changed_when: false
              failed_when: false

            - name: Fail if Git tag does not exist
              fail:
                msg: |
                  Git tag 'argocd-regression-v{{ target_version }}' does not exist.
                  Available tags: {{ available_tags.stdout_lines }}

                  To create a new version tag:
                  1. Make your changes on main branch
                  2. Commit changes
                  3. Create tag: git tag -a argocd-regression-v{{ target_version }} -m "Version {{ target_version }}"
                  4. Push: git push origin main argocd-regression-v{{ target_version }}
              when: git_tag_check.stdout == ""
              vars:
                available_tags: "{{ lookup('pipe', 'git -C ' + project_root + ' tag -l argocd-regression-v*') }}"

            - name: Save current Git branch/commit
              command: git rev-parse --abbrev-ref HEAD
              args:
                chdir: "{{ project_root }}"
              register: current_branch
              changed_when: false

            - name: Checkout Git tag for target version
              command: git checkout argocd-regression-v{{ target_version }}
              args:
                chdir: "{{ project_root }}"
              register: git_checkout
              changed_when: true

            - name: Display checkout information
              debug:
                msg:
                  - "Checked out Git tag: argocd-regression-v{{ target_version }}"
                  - "Previous branch: {{ current_branch.stdout }}"

            - name: Build backend with Maven
              command: /opt/maven/bin/mvn clean package -Dmaven.test.skip=true
              args:
                chdir: "{{ backend_dir }}"
              environment:
                MAVEN_OPTS: "-Xmx512m"
                JAVA_HOME: "/usr/lib/jvm/java-17-openjdk-17.0.18.0.8-1.el9.x86_64"
                PATH: "/opt/maven/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
              register: backend_build
              changed_when: true

            - name: Verify backend JAR exists
              stat:
                path: "{{ backend_dir }}/target/orgmgmt-backend.jar"
              register: backend_jar
              failed_when: not backend_jar.stat.exists

            - name: Install frontend dependencies
              command: npm install
              args:
                chdir: "{{ frontend_dir }}"
              register: frontend_deps
              changed_when: true

            - name: Build frontend with Vite
              command: npm run build
              args:
                chdir: "{{ frontend_dir }}"
              register: frontend_build
              changed_when: true

            - name: Verify frontend dist exists
              stat:
                path: "{{ frontend_dir }}/dist"
              register: frontend_dist
              failed_when: not frontend_dist.stat.exists

            - name: Build backend container image
              command: podman build -t orgmgmt-backend:{{ target_version }} -t orgmgmt-backend:latest -f Dockerfile .
              args:
                chdir: "{{ backend_dir }}"
              register: backend_image
              changed_when: true

            - name: Build frontend container image
              command: podman build -t orgmgmt-frontend:{{ target_version }} -t orgmgmt-frontend:latest -f Dockerfile .
              args:
                chdir: "{{ frontend_dir }}"
              register: frontend_image
              changed_when: true

            - name: Remove old export files
              file:
                path: "{{ item }}"
                state: absent
              loop:
                - /tmp/backend.tar
                - /tmp/frontend.tar
              become: yes

            - name: Export backend image
              command: podman save localhost/orgmgmt-backend:{{ target_version }} localhost/orgmgmt-backend:latest -o /tmp/backend.tar
              register: export_backend
              changed_when: true

            - name: Export frontend image
              command: podman save localhost/orgmgmt-frontend:{{ target_version }} localhost/orgmgmt-frontend:latest -o /tmp/frontend.tar
              register: export_frontend
              changed_when: true

            - name: Import images into K3s
              shell: |
                /usr/local/bin/k3s ctr images import /tmp/backend.tar
                /usr/local/bin/k3s ctr images import /tmp/frontend.tar
              register: import_images
              changed_when: true

            - name: Restore Git branch
              command: git checkout {{ current_branch.stdout }}
              args:
                chdir: "{{ project_root }}"
              register: git_restore
              changed_when: true
              when: current_branch.stdout != "HEAD"

            - name: Update backend service external IP
              command: >
                /usr/local/bin/k3s kubectl patch service orgmgmt-backend
                -n default
                -p '{"spec":{"externalIPs":["{{ private_ip }}"]}}'
              register: patch_backend_service
              changed_when: true

            - name: Update frontend service external IP
              command: >
                /usr/local/bin/k3s kubectl patch service orgmgmt-frontend
                -n default
                -p '{"spec":{"externalIPs":["{{ private_ip }}"]}}'
              register: patch_frontend_service
              changed_when: true

            - name: Update backend deployment image
              command: >
                /usr/local/bin/k3s kubectl set image
                deployment/orgmgmt-backend
                backend=localhost/orgmgmt-backend:{{ target_version }}
              register: backend_image_update
              changed_when: true

            - name: Update frontend deployment image
              command: >
                /usr/local/bin/k3s kubectl set image
                deployment/orgmgmt-frontend
                frontend=localhost/orgmgmt-frontend:{{ target_version }}
              register: frontend_image_update
              changed_when: true

            - name: Display version-based rollback status
              debug:
                msg:
                  - "âœ… Rolled back to version {{ target_version }} (built from Git tag argocd-regression-v{{ target_version }})"
                  - "Backend: Built and deployed"
                  - "Frontend: Built and deployed"
          when: target_version != ""

        # ã‚±ãƒ¼ã‚¹2: ç‰¹å®šã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
        - name: Rollback to specific revision
          block:
            - name: Rollback backend to specific revision
              command: >
                /usr/local/bin/k3s kubectl rollout undo
                deployment/orgmgmt-backend
                --to-revision={{ target_revision }}
              register: backend_rollback_rev
              changed_when: true

            - name: Rollback frontend to specific revision
              command: >
                /usr/local/bin/k3s kubectl rollout undo
                deployment/orgmgmt-frontend
                --to-revision={{ target_revision }}
              register: frontend_rollback_rev
              changed_when: true

            - name: Display revision-based rollback status
              debug:
                msg:
                  - "âœ… Rolled back to revision {{ target_revision }}"
                  - "Backend: {{ backend_rollback_rev.stdout }}"
                  - "Frontend: {{ frontend_rollback_rev.stdout }}"
          when: target_version == "" and target_revision != ""

        # ã‚±ãƒ¼ã‚¹3: æŒ‡å®šãªã—ï¼ˆç›´å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ï¼‰
        - name: Rollback to previous version (default)
          block:
            - name: Rollback backend to previous version
              command: /usr/local/bin/k3s kubectl rollout undo deployment/orgmgmt-backend
              register: backend_rollback_default
              changed_when: true

            - name: Rollback frontend to previous version
              command: /usr/local/bin/k3s kubectl rollout undo deployment/orgmgmt-frontend
              register: frontend_rollback_default
              changed_when: true

            - name: Display default rollback status
              debug:
                msg:
                  - "âœ… Rolled back to previous version"
                  - "Backend: {{ backend_rollback_default.stdout }}"
                  - "Frontend: {{ frontend_rollback_default.stdout }}"
          when: target_version == "" and target_revision == ""

    # ========================================
    # Phase 2: ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆå®Œäº†å¾…æ©Ÿ
    # ========================================
    - name: "PHASE 2: Wait for Rollout to Complete"
      block:
        - name: Wait for backend rollout
          command: /usr/local/bin/k3s kubectl rollout status deployment/orgmgmt-backend --timeout=300s
          register: backend_rollout_status
          changed_when: false

        - name: Wait for frontend rollout
          command: /usr/local/bin/k3s kubectl rollout status deployment/orgmgmt-frontend --timeout=300s
          register: frontend_rollout_status
          changed_when: false

        - name: Display rollout status
          debug:
            msg:
              - "âœ… Backend rollout completed"
              - "âœ… Frontend rollout completed"

    # ========================================
    # Phase 3: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®çŠ¶æ…‹ç¢ºèª
    # ========================================
    - name: "PHASE 3: Verify Rollback"
      block:
        - name: Get rolled back backend image
          shell: |
            /usr/local/bin/k3s kubectl get deployment orgmgmt-backend -o jsonpath='{.spec.template.spec.containers[0].image}'
          register: rolled_back_backend_image
          changed_when: false

        - name: Get rolled back frontend image
          shell: |
            /usr/local/bin/k3s kubectl get deployment orgmgmt-frontend -o jsonpath='{.spec.template.spec.containers[0].image}'
          register: rolled_back_frontend_image
          changed_when: false

        - name: Get backend pods status
          shell: |
            /usr/local/bin/k3s kubectl get pods -l app=orgmgmt-backend -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\t"}{.status.phase}{"\n"}{end}'
          register: backend_pods_status
          changed_when: false

        - name: Get frontend pods status
          shell: |
            /usr/local/bin/k3s kubectl get pods -l app=orgmgmt-frontend -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\t"}{.status.phase}{"\n"}{end}'
          register: frontend_pods_status
          changed_when: false

        - name: Display rolled back deployment status
          debug:
            msg:
              - "=========================================="
              - "Rolled Back Deployment Status"
              - "=========================================="
              - ""
              - "Previous Images:"
              - "  Backend: {{ current_backend_image.stdout }}"
              - "  Frontend: {{ current_frontend_image.stdout }}"
              - ""
              - "Current Images:"
              - "  Backend: {{ rolled_back_backend_image.stdout }}"
              - "  Frontend: {{ rolled_back_frontend_image.stdout }}"
              - ""
              - "Backend Pods:"
              - "{{ backend_pods_status.stdout_lines }}"
              - ""
              - "Frontend Pods:"
              - "{{ frontend_pods_status.stdout_lines }}"
              - ""
              - "=========================================="

    # ========================================
    # Phase 4: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    # ========================================
    - name: "PHASE 4: Health Checks"
      block:
        - name: Wait for backend health check
          uri:
            url: "http://{{ private_ip }}:8083/actuator/health"
            status_code: 200
            timeout: 5
          register: backend_health
          retries: 30
          delay: 10
          until: backend_health.status == 200

        - name: Wait for frontend to respond
          uri:
            url: "http://{{ private_ip }}:5006/"
            status_code: 200
            timeout: 5
          register: frontend_health
          retries: 10
          delay: 5
          until: frontend_health.status == 200

        - name: Get system info from backend API
          uri:
            url: "http://{{ private_ip }}:8083/api/system/info"
            method: GET
            return_content: yes
          register: system_info
          failed_when: false

        - name: Display health check results
          debug:
            msg:
              - "Health Check Results:"
              - "  Backend API: âœ… {{ backend_health.status }}"
              - "  Frontend: âœ… {{ frontend_health.status }}"

        - name: Display system information
          debug:
            msg:
              - "System Information:"
              - "{{ system_info.json | to_nice_json }}"
          when: system_info.json is defined

    # ========================================
    # Phase 5: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´æ›´æ–°
    # ========================================
    - name: "PHASE 5: Update Version History"
      block:
        - name: Extract version from image tag
          set_fact:
            rolled_back_version: "{{ rolled_back_backend_image.stdout | regex_search(':(.+)$', '\\1') | first }}"

        - name: Record rollback in version history
          lineinfile:
            path: "{{ version_history_file }}"
            line: "{{ ansible_date_time.iso8601 }} | ROLLBACK | {{ rolled_back_version }} | Backend: {{ rolled_back_backend_image.stdout }}, Frontend: {{ rolled_back_frontend_image.stdout }}"
            create: yes
            mode: '0644'
          become: no

        - name: Display version history update
          debug:
            msg:
              - "âœ… Version history updated"
              - "Rollback to: {{ rolled_back_version }}"

    # ========================================
    # Phase 6: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã‚µãƒãƒªãƒ¼
    # ========================================
    - name: Display rollback completion summary
      debug:
        msg:
          - "=========================================="
          - "ğŸ”„ ROLLBACK COMPLETE!"
          - "=========================================="
          - ""
          - "Rolled Back To:"
          - "  Backend: {{ rolled_back_backend_image.stdout }}"
          - "  Frontend: {{ rolled_back_frontend_image.stdout }}"
          - ""
          - "âœ… Deployments Rolled Back"
          - "âœ… Pods Restarted"
          - "âœ… Health Checks Passed"
          - "âœ… Version History Updated"
          - ""
          - "Access URLs:"
          - "  Frontend:     http://{{ private_ip }}:5006"
          - "  Backend API:  http://{{ private_ip }}:8083"
          - "  System Info:  http://{{ private_ip }}:8083/api/system/info"
          - ""
          - "Verification:"
          - "  1. Access frontend and check System Information card"
          - "  2. Verify Pod names have changed"
          - "  3. Test application functionality"
          - ""
          - "Rollback History:"
          - "  View: cat {{ version_history_file }}"
          - ""
          - "To rollback again:"
          - "  ansible-playbook playbooks/rollback_app_version.yml"
          - ""
          - "To upgrade to new version:"
          - "  ansible-playbook playbooks/deploy_app_version.yml -e 'app_version=X.Y.Z'"
          - ""
          - "=========================================="
