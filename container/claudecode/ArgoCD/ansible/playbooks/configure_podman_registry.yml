---
- name: Configure Podman Insecure Registry
  hosts: localhost
  gather_facts: yes
  become: yes
  vars:
    registry_host: "localhost:5005"
    registries_conf_dir: "/etc/containers/registries.conf.d"
    gitlab_registry_conf: "{{ registries_conf_dir }}/gitlab.conf"

  tasks:
    - name: Check if podman is installed
      command: which podman
      register: podman_check
      failed_when: false
      changed_when: false

    - name: Fail if podman is not installed
      fail:
        msg: "Podman is not installed. Please install podman first."
      when: podman_check.rc != 0

    - name: Display podman version
      command: podman --version
      register: podman_version
      changed_when: false

    - name: Show podman version
      debug:
        msg: "{{ podman_version.stdout }}"

    - name: Ensure registries.conf.d directory exists
      file:
        path: "{{ registries_conf_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Check if gitlab registry configuration exists
      stat:
        path: "{{ gitlab_registry_conf }}"
      register: gitlab_conf_stat

    - name: Backup existing gitlab registry configuration
      copy:
        src: "{{ gitlab_registry_conf }}"
        dest: "{{ gitlab_registry_conf }}.backup.{{ ansible_date_time.iso8601_basic_short }}"
        remote_src: yes
        mode: '0644'
      when: gitlab_conf_stat.stat.exists

    - name: Create GitLab insecure registry configuration
      copy:
        dest: "{{ gitlab_registry_conf }}"
        mode: '0644'
        owner: root
        group: root
        content: |
          # GitLab Container Registry Configuration
          # This file configures Podman to trust the insecure GitLab registry
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          [[registry]]
          location = "{{ registry_host }}"
          insecure = true

          # Allow pulling and pushing without TLS verification
          [[registry.mirror]]
          location = "{{ registry_host }}"
          insecure = true
      register: registry_config_created

    - name: Display configuration file location
      debug:
        msg: "Registry configuration created at {{ gitlab_registry_conf }}"
      when: registry_config_created is changed

    - name: Verify registry configuration file
      command: cat {{ gitlab_registry_conf }}
      register: conf_content
      changed_when: false

    - name: Display registry configuration
      debug:
        msg: "{{ conf_content.stdout_lines }}"

    - name: Check main registries.conf file
      stat:
        path: /etc/containers/registries.conf
      register: main_registries_conf

    - name: Display main registries.conf status
      debug:
        msg: "Main registries.conf exists at /etc/containers/registries.conf"
      when: main_registries_conf.stat.exists

    - name: Test registry connectivity
      command: curl -v http://{{ registry_host }}/v2/
      register: registry_curl
      failed_when: false
      changed_when: false
      ignore_errors: yes

    - name: Display registry connectivity status
      debug:
        msg: "Registry is accessible at {{ registry_host }}"
      when: registry_curl.rc == 0

    - name: Check podman info for registry configuration
      command: podman info --format json
      register: podman_info_json
      changed_when: false
      failed_when: false

    - name: Verify insecure registry in podman info
      shell: podman info | grep -A 5 "insecure"
      register: podman_insecure_check
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Display insecure registry configuration
      debug:
        msg: "{{ podman_insecure_check.stdout_lines }}"
      when:
        - podman_insecure_check.rc == 0
        - podman_insecure_check.stdout_lines | length > 0

    - name: Test registry login (if GitLab is running)
      command: podman login {{ registry_host }} --username root --password GitLabRoot123! --tls-verify=false
      register: registry_login
      failed_when: false
      changed_when: false
      ignore_errors: yes

    - name: Display registry login result
      debug:
        msg: "Successfully authenticated with GitLab registry"
      when: registry_login.rc == 0

    - name: Display registry login failure
      debug:
        msg:
          - "Registry login failed. This is expected if GitLab is not running yet."
          - "Error: {{ registry_login.stderr }}"
      when: registry_login.rc != 0

    - name: Create helper script for registry operations
      copy:
        dest: /usr/local/bin/gitlab-registry-login
        mode: '0755'
        owner: root
        group: root
        content: |
          #!/bin/bash
          # GitLab Registry Login Helper
          # This script logs into the GitLab container registry

          REGISTRY_HOST="${REGISTRY_HOST:-localhost:5005}"
          GITLAB_USERNAME="${GITLAB_USERNAME:-root}"
          GITLAB_PASSWORD="${GITLAB_PASSWORD:-GitLabRoot123!}"

          echo "Logging into GitLab Registry at $REGISTRY_HOST..."
          podman login "$REGISTRY_HOST" \
            --username "$GITLAB_USERNAME" \
            --password "$GITLAB_PASSWORD" \
            --tls-verify=false

          if [ $? -eq 0 ]; then
            echo "Successfully logged into GitLab Registry"
          else
            echo "Failed to login to GitLab Registry"
            exit 1
          fi
      register: helper_script_created

    - name: Display helper script location
      debug:
        msg: "Helper script created at /usr/local/bin/gitlab-registry-login"
      when: helper_script_created is changed

    - name: Restart podman socket if needed
      systemd:
        name: podman.socket
        state: restarted
      register: podman_socket_restart
      failed_when: false
      ignore_errors: yes
      when: registry_config_created is changed

    - name: Display podman socket restart status
      debug:
        msg: "Podman socket restarted"
      when:
        - podman_socket_restart is defined
        - podman_socket_restart is changed

    - name: Display configuration summary
      debug:
        msg:
          - "=========================================="
          - "Podman Registry Configuration Complete!"
          - "=========================================="
          - ""
          - "Insecure Registry: {{ registry_host }}"
          - "Configuration File: {{ gitlab_registry_conf }}"
          - ""
          - "To login to the registry:"
          - "  podman login {{ registry_host }} --username root --password GitLabRoot123! --tls-verify=false"
          - ""
          - "Or use the helper script:"
          - "  /usr/local/bin/gitlab-registry-login"
          - ""
          - "To push images:"
          - "  podman tag myimage:latest {{ registry_host }}/root/myproject/myimage:latest"
          - "  podman push {{ registry_host }}/root/myproject/myimage:latest --tls-verify=false"
          - ""
          - "To pull images:"
          - "  podman pull {{ registry_host }}/root/myproject/myimage:latest --tls-verify=false"
          - ""
          - "=========================================="
