---
- name: Verify ArgoCD Environment
  hosts: localhost
  connection: local
  gather_facts: yes
  become: no

  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Display verification header
      debug:
        msg:
          - "=========================================="
          - "ArgoCD Environment Verification"
          - "=========================================="

    # Container Verification
    - name: List all running containers
      command: podman ps --format "{{.Names}}"
      register: running_containers
      changed_when: false

    - name: Count running containers
      set_fact:
        container_count: "{{ running_containers.stdout_lines | length }}"

    - name: Display container count
      debug:
        msg: "Running containers: {{ container_count }}/{{ expected_container_count }}"

    - name: Check if all expected containers are running
      set_fact:
        missing_containers: "{{ container_names | difference(running_containers.stdout_lines) }}"

    - name: Display missing containers
      debug:
        msg: "Missing containers: {{ missing_containers }}"
      when: missing_containers | length > 0

    - name: Display container list
      command: podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      register: container_list
      changed_when: false

    - name: Show running containers
      debug:
        msg: "{{ container_list.stdout_lines }}"

    # Service Health Checks
    - name: Check PostgreSQL health
      command: podman exec {{ postgres_container_name }} pg_isready -U {{ postgres_user }} -d {{ postgres_db }}
      register: postgres_health
      changed_when: false
      failed_when: false

    - name: Display PostgreSQL status
      debug:
        msg: "PostgreSQL: {{ 'OK' if postgres_health.rc == 0 else 'FAILED' }}"

    - name: Check Redis health
      command: podman exec {{ argocd_redis_container }} redis-cli ping
      register: redis_health
      changed_when: false
      failed_when: false

    - name: Display Redis status
      debug:
        msg: "Redis: {{ 'OK' if redis_health.stdout == 'PONG' else 'FAILED' }}"

    - name: Check Nexus health
      uri:
        url: "{{ nexus_url }}/service/rest/v1/status"
        status_code: 200
      register: nexus_health
      failed_when: false

    - name: Display Nexus status
      debug:
        msg: "Nexus: {{ 'OK' if nexus_health.status == 200 else 'FAILED' }}"

    - name: Check GitLab health
      uri:
        url: "{{ gitlab_external_url }}/-/health"
        status_code: 200
      register: gitlab_health
      failed_when: false

    - name: Display GitLab status
      debug:
        msg: "GitLab: {{ 'OK' if gitlab_health.status == 200 else 'FAILED' }}"

    - name: Check ArgoCD health
      uri:
        url: "{{ service_urls.argocd }}/healthz"
        status_code: 200
      register: argocd_health
      failed_when: false

    - name: Display ArgoCD status
      debug:
        msg: "ArgoCD: {{ 'OK' if argocd_health.status == 200 else 'FAILED' }}"

    - name: Check pgAdmin health
      uri:
        url: "{{ service_urls.pgadmin }}"
        status_code: 200
      register: pgadmin_health
      failed_when: false

    - name: Display pgAdmin status
      debug:
        msg: "pgAdmin: {{ 'OK' if pgadmin_health.status == 200 else 'FAILED' }}"

    # Database Connectivity
    - name: Test PostgreSQL connectivity
      command: >
        podman exec {{ postgres_container_name }}
        psql -U {{ postgres_user }} -d {{ postgres_db }} -c "SELECT version();"
      register: postgres_version
      changed_when: false
      failed_when: false

    - name: Display database connectivity
      debug:
        msg: "Database connection: {{ 'OK' if postgres_version.rc == 0 else 'FAILED' }}"

    - name: Check database tables
      command: >
        podman exec {{ postgres_container_name }}
        psql -U {{ postgres_user }} -d {{ postgres_db }}
        -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public';"
      register: table_count
      changed_when: false
      failed_when: false

    - name: Display table count
      debug:
        msg: "Database tables: {{ table_count.stdout_lines[-1] if table_count.rc == 0 else 'N/A' }}"

    # ArgoCD CLI Check
    - name: Check ArgoCD CLI installation
      command: argocd version --client --short
      register: argocd_cli_version
      changed_when: false
      failed_when: false

    - name: Display ArgoCD CLI status
      debug:
        msg: "ArgoCD CLI: {{ argocd_cli_version.stdout if argocd_cli_version.rc == 0 else 'Not installed' }}"

    # Network Check
    - name: Check network
      command: podman network inspect {{ network_name }}
      register: network_check
      changed_when: false
      failed_when: false

    - name: Display network status
      debug:
        msg: "Network '{{ network_name }}': {{ 'OK' if network_check.rc == 0 else 'FAILED' }}"

    # Volume Check
    - name: List volumes
      command: podman volume ls --format "{{.Name}}"
      register: volumes_list
      changed_when: false

    - name: Count volumes
      set_fact:
        volume_count: "{{ volumes_list.stdout_lines | length }}"

    - name: Display volume count
      debug:
        msg: "Persistent volumes: {{ volume_count }}"

    # Disk Space Check
    - name: Check disk space
      shell: df -h {{ base_directory }} | tail -1 | awk '{print $4}'
      register: disk_available
      changed_when: false

    - name: Display disk space
      debug:
        msg: "Available disk space: {{ disk_available.stdout }}"

    # Memory Check
    - name: Check memory usage
      shell: free -h | awk '/^Mem:/ {print $3 "/" $2}'
      register: memory_usage
      changed_when: false

    - name: Display memory usage
      debug:
        msg: "Memory usage: {{ memory_usage.stdout }}"

    # Summary
    - name: Calculate health score
      set_fact:
        services_ok: >-
          {{
            (postgres_health.rc == 0) | int +
            (redis_health.stdout == 'PONG') | int +
            (nexus_health.status == 200) | int +
            (gitlab_health.status == 200) | int +
            (argocd_health.status == 200) | int +
            (pgadmin_health.status == 200) | int
          }}
        total_services: 6

    - name: Display verification summary
      debug:
        msg:
          - "=========================================="
          - "Verification Summary"
          - "=========================================="
          - ""
          - "Containers: {{ container_count }}/{{ expected_container_count }}"
          - "Services Healthy: {{ services_ok }}/{{ total_services }}"
          - "Network: {{ 'OK' if network_check.rc == 0 else 'FAILED' }}"
          - "Volumes: {{ volume_count }}"
          - "Disk Available: {{ disk_available.stdout }}"
          - "Memory Usage: {{ memory_usage.stdout }}"
          - ""
          - "Service Status:"
          - "  PostgreSQL: {{ 'OK' if postgres_health.rc == 0 else 'FAILED' }}"
          - "  Redis: {{ 'OK' if redis_health.stdout == 'PONG' else 'FAILED' }}"
          - "  Nexus: {{ 'OK' if nexus_health.status == 200 else 'FAILED' }}"
          - "  GitLab: {{ 'OK' if gitlab_health.status == 200 else 'FAILED' }}"
          - "  ArgoCD: {{ 'OK' if argocd_health.status == 200 else 'FAILED' }}"
          - "  pgAdmin: {{ 'OK' if pgadmin_health.status == 200 else 'FAILED' }}"
          - ""
          - "Overall Status: {{ 'HEALTHY' if services_ok | int == total_services | int and container_count | int == expected_container_count | int else 'DEGRADED' }}"
          - "=========================================="

    - name: Check if credentials file exists
      stat:
        path: "{{ credentials_file }}"
      register: creds_file

    - name: Display credentials location
      debug:
        msg: "Credentials: {{ credentials_file }} ({{ 'exists' if creds_file.stat.exists else 'not found' }})"

    - name: Final recommendations
      debug:
        msg:
          - ""
          - "Next Steps:"
          - "  - View credentials: cat {{ credentials_file }}"
          - "  - View logs: podman logs <container-name>"
          - "  - Restart service: podman restart <container-name>"
          - "  - Check status: podman ps"
          - ""
      when: services_ok | int < total_services | int or container_count | int < expected_container_count | int
