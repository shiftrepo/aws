# =============================================================================
# Frontend Dockerfile - Build from Nexus Artifact
# =============================================================================
# このDockerfileはNexusに登録されたアーティファクトからイメージを生成します
# 完全なCI/CDパイプラインの一部として使用されます

# Stage 1: Download artifact from Nexus
FROM docker.io/curlimages/curl:latest AS downloader

ARG NEXUS_URL=http://localhost:8000
ARG NEXUS_REPO=raw-hosted
ARG PACKAGE_NAME=orgmgmt-frontend
ARG PACKAGE_VERSION=1.0.0
ARG NEXUS_USER=admin
ARG NEXUS_PASSWORD=admin123

WORKDIR /tmp

# Download frontend tarball from Nexus (raw repository)
RUN echo "Downloading from Nexus: ${NEXUS_URL}/repository/${NEXUS_REPO}/${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz" && \
    curl -u ${NEXUS_USER}:${NEXUS_PASSWORD} \
         -f \
         -o frontend.tgz \
         "${NEXUS_URL}/repository/${NEXUS_REPO}/${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz" || \
    (echo "Failed to download from Nexus" && exit 1)

# Extract tarball
RUN tar -xzf frontend.tgz

# List contents for debugging
RUN ls -la /tmp/

# =============================================================================
# Stage 2: Nginx Runtime
# =============================================================================
FROM docker.io/library/nginx:1.25-alpine

# Metadata labels
LABEL org.opencontainers.image.title="OrgMgmt Frontend (from Nexus)" \
      org.opencontainers.image.description="Frontend built from Nexus artifact" \
      org.opencontainers.image.vendor="Example Corp" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.source="Nexus Repository"

# Install wget for healthcheck
RUN apk add --no-cache wget && \
    rm -rf /var/cache/apk/*

# Remove default nginx files
RUN rm -rf /usr/share/nginx/html/* && \
    rm -f /etc/nginx/conf.d/default.conf

# Copy nginx configuration with mock API
COPY container-builder/nginx-with-mock-api-fixed.conf /etc/nginx/conf.d/default.conf

# Copy frontend files from downloader stage
# The tarball structure is: package/dist/*
COPY --from=downloader /tmp/package/dist /usr/share/nginx/html

# Set proper permissions
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

# Verify files were copied
RUN ls -la /usr/share/nginx/html/

EXPOSE 80

HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
