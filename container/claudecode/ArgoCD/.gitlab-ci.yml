stages:
  - build-backend
  - test-backend
  - build-frontend
  - test-frontend
  - package
  - nexus-deploy
  - container-build
  - gitops-update
  - argocd-sync
  - e2e-test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  NEXUS_URL: "http://nexus:8081"
  REGISTRY_URL: "localhost:5005"
  ARGOCD_URL: "localhost:5010"
  VERSION: "$CI_COMMIT_SHORT_SHA"
  MAVEN_REPO: "maven-snapshots"
  NPM_REPO: "npm-hosted"
  BACKEND_IMAGE: "orgmgmt-backend"
  FRONTEND_IMAGE: "orgmgmt-frontend"

default:
  tags:
    - argocd
    - podman

# ============================================================================
# STAGE 1: BUILD BACKEND
# ============================================================================

maven-build:
  stage: build-backend
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Building backend application..."
    - cd app/backend
    - mvn clean compile -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
  cache:
    key: maven-cache
    paths:
      - .m2/repository/
  artifacts:
    paths:
      - app/backend/target/
    expire_in: 1 hour
  allow_failure: false

# ============================================================================
# STAGE 2: TEST BACKEND
# ============================================================================

maven-test:
  stage: test-backend
  image: maven:3.9-eclipse-temurin-17
  dependencies:
    - maven-build
  script:
    - echo "Running backend tests with coverage..."
    - cd app/backend
    - mvn test -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
    - echo "JaCoCo coverage report generated"
  cache:
    key: maven-cache
    paths:
      - .m2/repository/
    policy: pull
  artifacts:
    paths:
      - app/backend/target/site/jacoco/
      - app/backend/target/surefire-reports/
    reports:
      junit:
        - app/backend/target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: app/backend/target/site/jacoco/jacoco.xml
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  allow_failure: false

# ============================================================================
# STAGE 3: BUILD FRONTEND
# ============================================================================

npm-build:
  stage: build-frontend
  image: node:20-alpine
  script:
    - echo "Building frontend application..."
    - cd app/frontend
    - npm ci --cache .npm --prefer-offline
    - npm run build
    - echo "Frontend build completed successfully"
  cache:
    key: npm-cache
    paths:
      - app/frontend/.npm/
      - app/frontend/node_modules/
  artifacts:
    paths:
      - app/frontend/dist/
    expire_in: 1 hour
  allow_failure: false

# ============================================================================
# STAGE 4: TEST FRONTEND
# ============================================================================

npm-test:
  stage: test-frontend
  image: node:20-alpine
  dependencies:
    - npm-build
  script:
    - echo "Running frontend tests with coverage..."
    - cd app/frontend
    - npm ci --cache .npm --prefer-offline
    - npm test -- --coverage --passWithNoTests
    - echo "Frontend tests completed"
  cache:
    key: npm-cache
    paths:
      - app/frontend/.npm/
      - app/frontend/node_modules/
    policy: pull
  artifacts:
    paths:
      - app/frontend/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: app/frontend/coverage/cobertura-coverage.xml
    expire_in: 1 week
  coverage: '/Lines\s*:\s*([0-9.]+)%/'
  allow_failure: false

# ============================================================================
# STAGE 5: PACKAGE
# ============================================================================

package-backend:
  stage: package
  image: maven:3.9-eclipse-temurin-17
  dependencies:
    - maven-build
    - maven-test
  script:
    - echo "Packaging backend application..."
    - cd app/backend
    - mvn package -DskipTests -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
    - ls -lh target/*.jar
    - echo "Backend JAR packaged successfully"
  cache:
    key: maven-cache
    paths:
      - .m2/repository/
    policy: pull
  artifacts:
    paths:
      - app/backend/target/*.jar
    expire_in: 1 day
  allow_failure: false

package-frontend:
  stage: package
  image: node:20-alpine
  dependencies:
    - npm-build
  script:
    - echo "Packaging frontend application..."
    - cd app/frontend
    - tar -czf frontend-${VERSION}.tgz dist/
    - ls -lh frontend-*.tgz
    - echo "Frontend tarball created successfully"
  artifacts:
    paths:
      - app/frontend/frontend-*.tgz
    expire_in: 1 day
  allow_failure: false

# ============================================================================
# STAGE 6: NEXUS DEPLOY
# ============================================================================

deploy-maven:
  stage: nexus-deploy
  image: maven:3.9-eclipse-temurin-17
  dependencies:
    - package-backend
  before_script:
    - echo "Configuring Maven settings for Nexus..."
    - cp .gitlab-ci/settings.xml.template /root/.m2/settings.xml
    - sed -i "s|NEXUS_URL|${NEXUS_URL}|g" /root/.m2/settings.xml
    - sed -i "s|NEXUS_USERNAME|${NEXUS_USERNAME:-admin}|g" /root/.m2/settings.xml
    - sed -i "s|NEXUS_PASSWORD|${NEXUS_PASSWORD:-admin123}|g" /root/.m2/settings.xml
  script:
    - echo "Deploying backend JAR to Nexus..."
    - chmod +x .gitlab-ci/scripts/deploy-nexus-maven.sh
    - .gitlab-ci/scripts/deploy-nexus-maven.sh
  cache:
    key: maven-cache
    paths:
      - .m2/repository/
    policy: pull
  only:
    - main
    - develop
  allow_failure: false

deploy-npm:
  stage: nexus-deploy
  image: curlimages/curl:latest
  dependencies:
    - package-frontend
  script:
    - echo "Deploying frontend tarball to Nexus..."
    - chmod +x .gitlab-ci/scripts/deploy-nexus-npm.sh
    - .gitlab-ci/scripts/deploy-nexus-npm.sh
  only:
    - main
    - develop
  allow_failure: false

# ============================================================================
# STAGE 7: CONTAINER BUILD
# ============================================================================

build-containers:
  stage: container-build
  image: quay.io/podman/stable:latest
  dependencies:
    - deploy-maven
    - deploy-npm
  before_script:
    - podman --version
    - podman login ${REGISTRY_URL} -u ${REGISTRY_USERNAME:-admin} -p ${REGISTRY_PASSWORD:-admin123} || true
  script:
    - echo "Building container images from Nexus artifacts..."
    - chmod +x container-builder/scripts/build-from-nexus.sh
    - chmod +x container-builder/scripts/push-to-registry.sh
    - export VERSION=${VERSION}
    - container-builder/scripts/build-from-nexus.sh
    - echo "Pushing container images to registry..."
    - container-builder/scripts/push-to-registry.sh
  only:
    - main
    - develop
  allow_failure: false

# ============================================================================
# STAGE 8: GITOPS UPDATE
# ============================================================================

update-manifests:
  stage: gitops-update
  image: alpine/git:latest
  dependencies: []
  before_script:
    - apk add --no-cache yq
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI"
  script:
    - echo "Updating GitOps manifests with new image tags..."
    - chmod +x container-builder/scripts/update-gitops.sh
    - export VERSION=${VERSION}
    - export REGISTRY_URL=${REGISTRY_URL}
    - container-builder/scripts/update-gitops.sh
    - echo "GitOps manifests updated successfully"
  only:
    - main
  allow_failure: false

# ============================================================================
# STAGE 9: ARGOCD SYNC
# ============================================================================

deploy-dev:
  stage: argocd-sync
  image: argoproj/argocd:latest
  dependencies: []
  script:
    - echo "Triggering ArgoCD sync for dev environment..."
    - chmod +x .gitlab-ci/scripts/sync-argocd.sh
    - .gitlab-ci/scripts/sync-argocd.sh dev
  only:
    - main
  allow_failure: false
  environment:
    name: development
    url: http://localhost:5006

# ============================================================================
# STAGE 10: E2E TEST
# ============================================================================

playwright-tests:
  stage: e2e-test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  dependencies: []
  before_script:
    - echo "Waiting for application to be ready..."
    - sleep 30
    - chmod +x .gitlab-ci/scripts/check-health.sh
    - .gitlab-ci/scripts/check-health.sh
  script:
    - echo "Running Playwright E2E tests..."
    - cd app/frontend
    - npm ci --cache .npm --prefer-offline
    - npm run test:e2e || true
    - echo "E2E tests completed"
  cache:
    key: npm-cache
    paths:
      - app/frontend/.npm/
      - app/frontend/node_modules/
    policy: pull
  artifacts:
    paths:
      - app/frontend/playwright-report/
      - app/frontend/test-results/
      - app/frontend/screenshots/
    expire_in: 1 week
    when: always
  only:
    - main
  allow_failure: true
