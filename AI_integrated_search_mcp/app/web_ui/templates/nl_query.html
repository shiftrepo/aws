{% extends "base.html" %}

{% block title %}Natural Language Query{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-comments"></i> Natural Language Query</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="btnSampleQueries" data-bs-toggle="modal" data-bs-target="#sampleQueriesModal">
                        <i class="fas fa-lightbulb"></i> Sample Queries
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Ask questions about the database in natural language. The system will translate your question into SQL and execute it.
                </div>
                <form id="nlQueryForm">
                    <div class="mb-3">
                        <textarea class="form-control" id="nlQuery" rows="3" placeholder="Ask a question about the database..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text">Max Results</span>
                            <input type="number" class="form-control" id="maxResults" value="20" min="1" max="1000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Ask Question
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnClear">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </form>
                <div id="executionStatus" class="alert alert-info d-none">
                    <i class="fas fa-spinner fa-spin"></i> Processing query...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 d-none" id="generatedSqlSection">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-code"></i> Generated SQL</h5>
                <div>
                    <span class="badge bg-info" id="confidenceScore"></span>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="sql-query-display bg-light p-3 rounded">
                        <pre><code class="language-sql" id="generatedSql"></code></pre>
                    </div>
                </div>
                <div class="mb-3">
                    <button class="btn btn-outline-secondary btn-sm" id="btnCopySQL">
                        <i class="fas fa-copy"></i> Copy SQL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 d-none" id="resultsSection">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Query Results</h5>
                <div>
                    <span id="rowCount" class="badge bg-info me-2"></span>
                    <span id="executionTime" class="badge bg-secondary"></span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="resultsTable">
                        <thead class="table-dark">
                            <tr id="resultsHeader"></tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
                <div id="noResults" class="alert alert-warning d-none">
                    <i class="fas fa-info-circle"></i> The query executed successfully but returned no results.
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-secondary" id="btnCopyResults">
                        <i class="fas fa-copy"></i> Copy Results
                    </button>
                    <button class="btn btn-outline-secondary" id="btnDownloadCSV">
                        <i class="fas fa-download"></i> Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 d-none" id="errorSection">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> Query Error</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" id="errorMessage"></div>
            </div>
        </div>
    </div>
</div>

<!-- Sample Queries Modal -->
<div class="modal fade" id="sampleQueriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-lightbulb"></i> Sample Natural Language Questions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    {% for query in sample_queries %}
                    <button type="button" class="list-group-item list-group-item-action sample-query" 
                            data-query="{{ query }}" data-bs-dismiss="modal">
                        {{ query }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle form submission
        $('#nlQueryForm').submit(function(e) {
            e.preventDefault();
            
            const query = $('#nlQuery').val().trim();
            if (!query) {
                alert('Please enter a question');
                return;
            }
            
            const maxResults = parseInt($('#maxResults').val()) || 20;
            
            // Show execution status
            $('#executionStatus').removeClass('d-none');
            $('#generatedSqlSection').addClass('d-none');
            $('#resultsSection').addClass('d-none');
            $('#errorSection').addClass('d-none');
            
            // Execute the query
            $.ajax({
                url: '/execute-nl',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    query: query,
                    max_results: maxResults
                }),
                success: function(response) {
                    // Hide execution status
                    $('#executionStatus').addClass('d-none');
                    
                    if (response.error) {
                        // Show error
                        $('#errorMessage').text(response.error);
                        $('#errorSection').removeClass('d-none');
                    } else {
                        // Display generated SQL
                        $('#generatedSql').text(response.generated_sql);
                        $('#confidenceScore').text('Confidence: ' + 
                            (response.confidence_score * 100).toFixed(1) + '%');
                        $('#generatedSqlSection').removeClass('d-none');
                        hljs.highlightElement(document.getElementById('generatedSql'));
                        
                        // Display results if available
                        if (response.results) {
                            displayResults(response);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    // Hide execution status
                    $('#executionStatus').addClass('d-none');
                    
                    // Try to parse the error
                    let errorMessage = 'An error occurred';
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText || error || errorMessage;
                    }
                    
                    // Show error
                    $('#errorMessage').text(errorMessage);
                    $('#errorSection').removeClass('d-none');
                }
            });
        });
        
        // Clear button
        $('#btnClear').click(function() {
            $('#nlQuery').val('');
            $('#generatedSqlSection').addClass('d-none');
            $('#resultsSection').addClass('d-none');
            $('#errorSection').addClass('d-none');
        });
        
        // Sample query click
        $('.sample-query').click(function() {
            const query = $(this).data('query');
            $('#nlQuery').val(query);
        });
        
        // Copy SQL
        $('#btnCopySQL').click(function() {
            const sqlText = $('#generatedSql').text();
            
            // Create a temporary textarea element
            const textarea = document.createElement('textarea');
            textarea.value = sqlText;
            document.body.appendChild(textarea);
            
            // Select and copy
            textarea.select();
            document.execCommand('copy');
            
            // Remove the temporary textarea
            document.body.removeChild(textarea);
            
            alert('SQL copied to clipboard');
        });
        
        // Copy results
        $('#btnCopyResults').click(function() {
            const table = document.getElementById('resultsTable');
            
            // Create a range and select the table
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            // Copy the selection
            try {
                document.execCommand('copy');
                alert('Results copied to clipboard');
            } catch (err) {
                alert('Failed to copy results: ' + err);
            } finally {
                window.getSelection().removeAllRanges();
            }
        });
        
        // Download CSV
        $('#btnDownloadCSV').click(function() {
            // Get table data
            const table = document.getElementById('resultsTable');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length < 1) return;
            
            const csvContent = [];
            
            // Get headers
            const headers = rows[0].querySelectorAll('th');
            const headerRow = [];
            headers.forEach(header => headerRow.push('"' + header.textContent.replace(/"/g, '""') + '"'));
            csvContent.push(headerRow.join(','));
            
            // Get data rows
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                const dataRow = [];
                
                cells.forEach(cell => {
                    const value = cell.textContent.replace(/"/g, '""');
                    dataRow.push('"' + value + '"');
                });
                
                csvContent.push(dataRow.join(','));
            }
            
            // Create CSV blob and download
            const csv = csvContent.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'nl_query_results.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Function to display results
        function displayResults(response) {
            // The response structure is different for NL queries, we need to extract actual SQL results
            const sqlResults = response.results;
            
            if (!sqlResults || sqlResults.error) {
                // Show error if there was an issue with the SQL execution
                $('#errorMessage').text(sqlResults ? sqlResults.error : 'Failed to execute generated SQL');
                $('#errorSection').removeClass('d-none');
                return;
            }
            
            // Display metadata
            const rowCount = sqlResults.rows ? sqlResults.rows.length : 0;
            $('#rowCount').text(rowCount + ' rows');
            $('#executionTime').text('Execution time: ' + response.execution_time.toFixed(3) + 's');
            
            // Clear previous results
            $('#resultsHeader').empty();
            $('#resultsBody').empty();
            
            // Show no results message if needed
            if (!sqlResults.rows || sqlResults.rows.length === 0) {
                $('#noResults').removeClass('d-none');
                $('#resultsTable').addClass('d-none');
            } else {
                $('#noResults').addClass('d-none');
                $('#resultsTable').removeClass('d-none');
                
                // Add headers
                sqlResults.columns.forEach(column => {
                    $('#resultsHeader').append('<th>' + column + '</th>');
                });
                
                // Add rows
                sqlResults.rows.forEach(row => {
                    let rowHtml = '<tr>';
                    sqlResults.columns.forEach(column => {
                        const value = row[column];
                        rowHtml += '<td>' + (value !== null ? value : '<em class="text-muted">NULL</em>') + '</td>';
                    });
                    rowHtml += '</tr>';
                    $('#resultsBody').append(rowHtml);
                });
            }
            
            // Show results section
            $('#resultsSection').removeClass('d-none');
        }
    });
</script>
{% endblock %}
