{% extends "base.html" %}

{% block title %}SQL Query Interface{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-database"></i> SQL Query</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="btnSampleQueries" data-bs-toggle="modal" data-bs-target="#sampleQueriesModal">
                        <i class="fas fa-lightbulb"></i> Sample Queries
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="sqlQueryForm">
                    <div class="mb-3">
                        <textarea class="form-control sql-editor" id="sqlQuery" rows="5" placeholder="Enter SQL query here..."></textarea>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play"></i> Execute Query
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnClear">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </form>
                <div id="executionStatus" class="alert alert-info d-none">
                    <i class="fas fa-spinner fa-spin"></i> Executing query...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 d-none" id="resultsSection">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Query Results</h5>
                <div>
                    <span id="rowCount" class="badge bg-info me-2"></span>
                    <span id="executionTime" class="badge bg-secondary"></span>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="sql-query-display bg-light p-3 rounded">
                        <pre><code class="language-sql" id="executedQueryDisplay"></code></pre>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="resultsTable">
                        <thead class="table-dark">
                            <tr id="resultsHeader"></tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
                <div id="noResults" class="alert alert-warning d-none">
                    <i class="fas fa-info-circle"></i> The query executed successfully but returned no results.
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-secondary" id="btnCopyResults">
                        <i class="fas fa-copy"></i> Copy Results
                    </button>
                    <button class="btn btn-outline-secondary" id="btnDownloadCSV">
                        <i class="fas fa-download"></i> Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 d-none" id="errorSection">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> Query Error</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" id="errorMessage"></div>
                <div class="mb-3">
                    <div class="sql-query-display bg-light p-3 rounded">
                        <pre><code class="language-sql" id="errorQueryDisplay"></code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sample Queries Modal -->
<div class="modal fade" id="sampleQueriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-lightbulb"></i> Sample SQL Queries</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    {% for query in sample_queries %}
                    <button type="button" class="list-group-item list-group-item-action sample-query" 
                            data-query="{{ query.query }}" data-bs-dismiss="modal">
                        <strong>{{ query.name }}</strong>
                        <p class="mb-1"><code>{{ query.query }}</code></p>
                        <small class="text-muted">{{ query.description }}</small>
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle form submission
        $('#sqlQueryForm').submit(function(e) {
            e.preventDefault();
            
            const query = $('#sqlQuery').val().trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }
            
            // Show execution status
            $('#executionStatus').removeClass('d-none');
            $('#resultsSection').addClass('d-none');
            $('#errorSection').addClass('d-none');
            
            // Execute the query
            $.ajax({
                url: '/execute-sql',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ query: query }),
                success: function(response) {
                    // Hide execution status
                    $('#executionStatus').addClass('d-none');
                    
                    if (response.error) {
                        // Show error
                        $('#errorMessage').text(response.error);
                        $('#errorQueryDisplay').text(response.query || query);
                        $('#errorSection').removeClass('d-none');
                        hljs.highlightElement(document.getElementById('errorQueryDisplay'));
                    } else {
                        // Display results
                        displayResults(response, query);
                    }
                },
                error: function(xhr, status, error) {
                    // Hide execution status
                    $('#executionStatus').addClass('d-none');
                    
                    // Show error
                    $('#errorMessage').text(xhr.responseText || error || 'An error occurred');
                    $('#errorQueryDisplay').text(query);
                    $('#errorSection').removeClass('d-none');
                    hljs.highlightElement(document.getElementById('errorQueryDisplay'));
                }
            });
        });
        
        // Clear button
        $('#btnClear').click(function() {
            $('#sqlQuery').val('');
            $('#resultsSection').addClass('d-none');
            $('#errorSection').addClass('d-none');
        });
        
        // Sample query click
        $('.sample-query').click(function() {
            const query = $(this).data('query');
            $('#sqlQuery').val(query);
        });
        
        // Copy results
        $('#btnCopyResults').click(function() {
            const table = document.getElementById('resultsTable');
            
            // Create a range and select the table
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            // Copy the selection
            try {
                document.execCommand('copy');
                alert('Results copied to clipboard');
            } catch (err) {
                alert('Failed to copy results: ' + err);
            } finally {
                window.getSelection().removeAllRanges();
            }
        });
        
        // Download CSV
        $('#btnDownloadCSV').click(function() {
            // Get table data
            const table = document.getElementById('resultsTable');
            const rows = table.querySelectorAll('tr');
            
            if (rows.length < 1) return;
            
            const csvContent = [];
            
            // Get headers
            const headers = rows[0].querySelectorAll('th');
            const headerRow = [];
            headers.forEach(header => headerRow.push('"' + header.textContent.replace(/"/g, '""') + '"'));
            csvContent.push(headerRow.join(','));
            
            // Get data rows
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                const dataRow = [];
                
                cells.forEach(cell => {
                    const value = cell.textContent.replace(/"/g, '""');
                    dataRow.push('"' + value + '"');
                });
                
                csvContent.push(dataRow.join(','));
            }
            
            // Create CSV blob and download
            const csv = csvContent.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'query_results.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Function to display results
        function displayResults(response, query) {
            // Display query
            $('#executedQueryDisplay').text(query);
            hljs.highlightElement(document.getElementById('executedQueryDisplay'));
            
            // Display metadata
            const rowCount = response.rows ? response.rows.length : 0;
            $('#rowCount').text(rowCount + ' rows');
            $('#executionTime').text('Execution time: ' + response.execution_time.toFixed(3) + 's');
            
            // Clear previous results
            $('#resultsHeader').empty();
            $('#resultsBody').empty();
            
            // Show no results message if needed
            if (!response.rows || response.rows.length === 0) {
                $('#noResults').removeClass('d-none');
                $('#resultsTable').addClass('d-none');
            } else {
                $('#noResults').addClass('d-none');
                $('#resultsTable').removeClass('d-none');
                
                // Add headers
                response.columns.forEach(column => {
                    $('#resultsHeader').append('<th>' + column + '</th>');
                });
                
                // Add rows
                response.rows.forEach(row => {
                    let rowHtml = '<tr>';
                    response.columns.forEach(column => {
                        const value = row[column];
                        rowHtml += '<td>' + (value !== null ? value : '<em class="text-muted">NULL</em>') + '</td>';
                    });
                    rowHtml += '</tr>';
                    $('#resultsBody').append(rowHtml);
                });
            }
            
            // Show results section
            $('#resultsSection').removeClass('d-none');
        }
    });
</script>
{% endblock %}
